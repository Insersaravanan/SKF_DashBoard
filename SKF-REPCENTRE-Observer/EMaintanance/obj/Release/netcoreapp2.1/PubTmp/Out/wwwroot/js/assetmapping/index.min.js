app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.pinning","ui.grid.exporter","ui.bootstrap","ui.grid.selection");app.controller("skfCtrl",function($scope,$filter,uiGridConstants,clientFactory,$http,$uibModal,languageFactory,apiFactory,alertFactory,$timeout){function getCellClass(grid,row){return row.uid===highlightRow?"highlight":""}var _columns,highlightRow;$scope.searchEMaint=[];$scope.searchObserver=[];$scope.formatters={};_columns=[{name:"sno",displayName:"#",width:"2%",minWidth:50,cellClass:getCellClass,enableFiltering:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"ObserverDBId",displayName:"OB Id",cellClass:getCellClass,enableColumnResizing:!0,width:"2%",minWidth:90},{name:"PlantAreaName",displayName:"Plant Area",cellClass:getCellClass,enableColumnResizing:!0,width:"9%",minWidth:90},{name:"EquipmentName",displayName:"Equipment",cellClass:getCellClass,enableColumnResizing:!0,width:"16%",minWidth:120,aggregationHideLabel:!1,aggregationType:uiGridConstants.aggregationTypes.count,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total Count: {{col.getAggregationValue() | number:0 }}<\/div>'},{name:"UnitType",displayName:"Asset Type",cellClass:getCellClass,enableColumnResizing:!0,width:"10%",minWidth:70,cellTemplate:'<span class="ui-grid-cell-contents" ng-switch = "row.entity.UnitType"><span ng-switch-when="DR">Drive Unit<\/span><span ng-switch-when="IN">Intermediate Unit<\/span><span ng-switch-when="DN">Driven Unit<\/span><\/span>'},{name:"AssetName",displayName:"Asset Name",cellClass:getCellClass,enableColumnResizing:!0,width:"13%",minWidth:100},{name:"ObserverNodeName",displayName:"Asset Name(Observer)",cellClass:getCellClass,enableColumnResizing:!0,width:"16%",minWidth:120},{name:"ObserverNodePath",displayName:"Observer Path",cellClass:getCellClass,enableColumnResizing:!0,width:"20%",minWidth:150},{name:"Action",enableFiltering:!1,enableSorting:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.AssetMap(row)" ng-class="{disable: row.entity.ObserverNodeId}"> <i class="fa fa-link icon-space-before" tooltip-append-to-body="true" uib-tooltip="Map Asset" tooltip-class="customClass"><\/i><\/a><a ng-click="grid.appScope.removeMapping(row)" ng-class="{disable: row.entity.ObserverNodeId === null}"> <i class= "fa fa-chain-broken icon-space-before" tooltip-append-to-body="true" uib-tooltip="Unmap Asset" tooltip-class="customClass" ><\/i><\/a><\/div>',width:"6%",minWidth:50}];$scope.columns=angular.copy(_columns);highlightRow=null;$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableCellEdit:!1,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)};gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus"&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_AssetMapping.xlsx",exporterExcelSheetName:"EMaintenance_AssetMapping",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.selectClient=function(){var clientInfo=sessionStorage.getItem("clientInfo"),_client;clientFactory.setClient(clientInfo);clientInfo===null?sessionStorage.setItem("isClientSite","yes"):clientInfo&&clientInfo!=="undefined"&&(_client=JSON.parse(clientInfo),$scope.ClientSiteId=_client.ClientSiteId,$scope.ObserverClientNodeId=_client.ObserverNodeId,$scope.ClientDDL=_client)};$scope.loadData=function(){$scope.gridOpts.data=[];$http.get("/AssetMapping/GetAssetMappingList?cId="+$scope.ClientSiteId+"&lId="+$scope.language.LanguageId).then(function(response){$scope.gridOpts.data=response.data;$scope.ObserverDBId=$scope.gridOpts.data[0].ObserverDBId})};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!==oldValue&&newValue&&($scope.language=newValue,$scope.selectClient(),$scope.loadData())});$scope.AssetMap=function(row){let sRow=[];return sRow=$scope.gridOpts.data.filter(item=>item.ObserverNodeId!==null),sRow.length>0&&($scope.SelectedRow=sRow.filter(item=>item.ObserverNodeId!==row.ObserverNodeId)),$scope.assetMapping(row)};$scope.assetMapping=function(row){if(!$scope.ObserverClientNodeId){alertFactory.setMessage({type:"warning",msg:"The client has not been mapped."});return}var modalInstance=$uibModal.open({templateUrl:"skfAssetMappingModal.html",controller:"skfAssetMappingModalCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row,Selected:$scope.SelectedRow,ObserverDBId:$scope.ObserverDBId,ObserverClientNodeId:$scope.ObserverClientNodeId,LanguageID:$scope.language.LanguageId}}}});modalInstance.result.then(function(){$scope.loadData()},function(){})};$scope.removeMapping=function(row){var modalInstance=$uibModal.open({templateUrl:"skfAssetMappingDeleteModal.html",controller:"skfAssetMappingDeleteCtrl",size:"md",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row}}}});modalInstance.result.then(function(){$scope.loadData()},function(){})};$scope.clientMapping=function(){$scope.LanguageID=$scope.language.LanguageId;var modalInstance=$uibModal.open({templateUrl:"skfClientMappingAssetModal.html",controller:"skfClientMappingAssetModalCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{data:$scope.ClientDDL,ClientSiteId:$scope.ClientSiteId,LanguageId:$scope.LanguageID}}}});modalInstance.result.then(function(){$scope.loadData();$http.get("/UserClientSiteRel/GetUserClientSites?lId="+$scope.language.LanguageId+"&type=ClientSite&cId=&ccId=").then(function(response){for(i=0;i<=response.data.length;i++)response.data[i]&&response.data[i].ClientSiteId===$scope.ClientSiteId&&(sessionStorage.setItem("clientInfo",JSON.stringify(response.data[i])),$scope.ObserverClientNodeId=response.data[i].ObserverNodeId)})},function(){})}});app.controller("skfAssetMappingModalCtrl",function($scope,alertFactory,$http,$uibModalInstance,params){$scope.Selected={};$scope.ObserverDBId=params.row.entity.ObserverDBId;$scope.Selected=params.row.entity.ObserverNodeName;$scope.EMaintAssetName=params.row.entity.AssetName;$scope.SelectedObserver={};switch(params.row.entity.UnitType){case"DR":$scope.selectedAssetType="Drive Unit";break;case"IN":$scope.selectedAssetType="Intermediate Unit";break;case"DN":$scope.selectedAssetType="Driven Unit"}$scope.loadObserverAsset=function(){var _url="/Lookup/GetLookupByName?lId="+params.LanguageID+"&lName=Observer_URL_END_POINT";$http.get(_url).then(function(response){$scope.Observer_ASSET_URL=response.data[0].LValue;$http({method:"GET",url:$scope.Observer_ASSET_URL+"/InvokeObserver/GetOAssets/"+$scope.ObserverDBId+"/"+params.ObserverClientNodeId}).then(function(response){$scope.AssetsDDL=typeof params.Selected!="undefined"?response.data.filter(item=>!params.Selected.some(b=>item.IDNode===b.ObserverNodeId)):response.data})})}();$scope.save=function(data){$scope.SelectedObserver=data};$scope.saveMapping=function(){if(!$scope.SelectedObserver.IDNode){$scope.Selected={};alertFactory.setMessage({type:"warning",msg:"Please select the asset and save."});return}var headerData={AssetType:params.row.entity.UnitType,AssetId:params.row.entity.UnitId,ObserverNodeId:$scope.SelectedObserver.IDNode,ObserverNodeName:$scope.SelectedObserver.NodeName,ObserverNodePath:$scope.SelectedObserver.NodePath};$http.post("/AssetMapping/Create",JSON.stringify(headerData)).then(function(response){response.data&&(alertFactory.setMessage({msg:"Data saved Successfully."}),$uibModalInstance.close())},function(response){response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})};$scope.cancel=function(){$uibModalInstance.dismiss()}});app.controller("skfAssetMappingDeleteCtrl",function($scope,alertFactory,$http,$uibModalInstance,params){var _param=params;$scope.row=_param.row;$scope.EMaintAssetName=$scope.row.entity.AssetName;switch($scope.row.entity.UnitType){case"DR":$scope.selectedAssetType="Drive Unit";break;case"IN":$scope.selectedAssetType="Intermediate Unit";break;case"DN":$scope.selectedAssetType="Driven Unit"}$scope.deleteMapping=function(){var headerData={AssetType:$scope.row.entity.UnitType,AssetId:$scope.row.entity.UnitId,ObserverNodeId:null,ObserverNodeName:null,ObserverNodePath:null};$http.post("/AssetMapping/Create",JSON.stringify(headerData)).then(function(response){response.data&&(alertFactory.setMessage({msg:"Mapping removed successfully."}),$uibModalInstance.close())},function(response){response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})};$scope.cancel=function(){$uibModalInstance.dismiss()}});app.controller("skfClientMappingAssetModalCtrl",function($scope,alertFactory,$http,$uibModalInstance,params){$scope.ClientName=params.data.ClientSiteName;$scope.ClientSiteId=params.data.ClientSiteId;$scope.ClientMapping={ObserverDBId:null,ObserverDBName:null,ObserverNodeId:null,ObserverNodeName:null,ClientSiteId:null,ObserverNodePath:null};$scope.loadObserverClientDDL=function(){$scope.Assetdata=[];$http.get("/ClientMapping/GetClientMapping?lId="+params.LanguageId).then(function(response){$scope.mappingClient(response.data)})}();$scope.mappingClient=function(data){let sRow=[];return sRow=data.filter(item=>item.ObserverNodeId!==null),sRow.length>0&&($scope.SelectedRow=sRow.filter(item=>item.ObserverNodeId!==params.data.ObserverNodeId)),$scope.loadObserverDB()};$scope.loadObserverDB=function(){var _url="/Lookup/GetLookupByName?lId="+params.LanguageId+"&lName=Observer_URL_END_POINT";$http.get(_url).then(function(response){$scope.Observer_ENDPOINT_URL=response.data[0].LValue;$http({method:"GET",url:$scope.Observer_ENDPOINT_URL+"InvokeObserver/GetODBs"}).then(function(response){$scope.ObserverdbDDL=response.data;$scope.ClientMapping.ObserverDBId=221;$scope.ClientMapping.ObserverDBName="RMS226AO";$scope.loadObserverClient(221)})})};$scope.loadObserverClient=function(data){$scope.ObserverClientDDL=[];$http({method:"GET",url:$scope.Observer_ENDPOINT_URL+"InvokeObserver/GetOClients/"+data+"/0"}).then(function(response){$scope.ObserverClientDDL=typeof $scope.SelectedRow!="undefined"?response.data.filter(item=>!$scope.SelectedRow.some(b=>item.IDNode===b.ObserverNodeId)):response.data})};$scope.SaveODb=function(data){$scope.ClientMapping.ObserverDBName=data.Name;$scope.ClientMapping.ObserverDBId=data.Id;$scope.loadObserverClient(data.Id);$scope.ClientMapping.ObserverNodeId=null};$scope.SaveOClient=function(data){$scope.ClientMapping.NodeName=data.NodeName;$scope.ClientMapping.IDNode=data.IDNode;$scope.ClientMapping.NodePath=data.NodePath};$scope.save=function(){var postData,postUrl;if(!$scope.ClientMapping.IDNode){$scope.ClientMapping.ObserverNodeId=null;alertFactory.setMessage({type:"warning",msg:"Please select the Observer Client and save."});return}postData={ObserverDBId:$scope.ClientMapping.ObserverDBId,ObserverDBName:$scope.ClientMapping.ObserverDBName,ObserverNodeId:$scope.ClientMapping.IDNode,ObserverNodeName:$scope.ClientMapping.NodeName,ObserverNodePath:$scope.ClientMapping.NodePath,ClientSiteId:$scope.ClientSiteId};$scope.isProcess||($scope.isProcess=!0,postUrl="/ClientMapping/SaveClientMapping",$http.post(postUrl,JSON.stringify(postData)).then(function(response){response.status&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):(alertFactory.setMessage({msg:"Data saved Successfully."}),$uibModalInstance.close()));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})}))};$scope.cancel=function(){$uibModalInstance.dismiss()}});