app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.cellNav","ui.grid.pinning","ui.grid.exporter");app.controller("skfCtrl",function($scope,$filter,uiGridConstants,$http,$uibModal,languageFactory,alertFactory,clientFactory,$timeout){function getCellClass(grid,row){return row.uid===highlightRow?"highlight":""}var _columns,highlightRow;$scope.startIndex=1;$scope.formatters={};$scope.language=null;_columns=[{name:"sno",displayName:"#",width:"2%",minWidth:50,cellClass:getCellClass,enableFiltering:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"JobNumber",displayName:"Job Number",cellClass:getCellClass,enableColumnResizing:!0,width:"5%",minWidth:100},{name:"PlantAreaName",displayName:"Plant Area",enableColumnResizing:!0,width:"16%",minWidth:100,cellClass:getCellClass,aggregationType:uiGridConstants.aggregationTypes.count,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total Count: {{col.getAggregationValue() | number:0 }}<\/div>'},{name:"EquipmentName",displayName:"Equipment",cellClass:getCellClass,enableColumnResizing:!0,width:"16%",minWidth:100},{name:"LSQuoteReference",displayName:"CRM Reference",cellClass:getCellClass,enableColumnResizing:!0,width:"16%",minWidth:100},{name:"LSQuoteAmount",displayName:"quote Amount",cellClass:getCellClass,enableColumnResizing:!0,enableCellEdit:!1,minWidth:80,width:"10%"},{name:"LSQuoteComment",displayName:"Descriptions",cellClass:getCellClass,enableColumnResizing:!0,width:"18%",minWidth:150},{name:"Action",enableFiltering:!1,enableSorting:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.AddLeverage(row.entity)" <i class="fa fa-pencil-square-o icon-space-before" tooltip-append-to-body="true" uib-tooltip="Edit Leverage Service" tooltip-class="customClass"><\/i><\/a><a href="{{row.entity.LSPhysicalPath}}" target="_blank" ng-class="{disable: row.entity.LSPhysicalPath === null}"> <i class="fa fa-download icon-space-before" tooltip-append-to-body="true" uib-tooltip="Download" tooltip-class="customClass"><\/i><\/a><\/div>',width:"10%",minWidth:100}];highlightRow=null;$scope.columns=angular.copy(_columns);$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)};gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus"&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFileName:"EMaintenance_LeverageList.xlsx",exporterExcelSheetName:"EMaintenance_LeverageList",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};var date=new Date,y=date.getFullYear(),m=date.getMonth();$scope.L_Leverage={FromDate:new Date(y,m-1,1),ToDate:new Date};$scope.loadData=function(){$scope.gridOpts.data=[];var _url="/Leverage/GetLeverage?fromdate="+$filter("date")($scope.L_Leverage.FromDate,"yyyy-MM-dd 00:00:00")+"&todate="+$filter("date")($scope.L_Leverage.ToDate,"yyyy-MM-dd 00:00:00")+"&lId="+$scope.language.LanguageId;$http.get(_url).then(function(response){$scope.gridOpts.data=response.data;angular.forEach($scope.gridOpts.data,function(val,i){val.sno=i+1})})};$scope.selectClient=function(){var clientInfo=sessionStorage.getItem("clientInfo"),_client;clientFactory.setClient(clientInfo);clientInfo==null?sessionStorage.setItem("isClientSite","yes"):clientInfo&&clientInfo!="undefined"&&(_client=JSON.parse(clientInfo),$scope.ClientSiteId=_client.ClientSiteId)};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!=oldValue&&newValue&&($scope.language=newValue,$scope.selectClient(),$scope.loadData())});$scope.AddLeverage=function(row){var _url="/Leverage/GetLeverageServiceList?jeId="+row.JobEquipmentId+"&lId="+$scope.language.LanguageId;$http.get(_url).then(function(response){$scope.popupData=response.data;var modalInstance=$uibModal.open({templateUrl:"skfLeverageExternal.html",controller:"skfLeverageExternalCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{data:$scope.popupData,row:row,languageId:$scope.language.LanguageId,isEdit:!0}}}});modalInstance.result.then(function(){$scope.loadData()},function(){})})}});app.controller("skfLeverageExternalCtrl",function($scope,$http,$filter,$uibModal,$uibModalInstance,params,uiGridConstants,alertFactory,$timeout){$scope.isEdit=!1;$scope.EquipmentName=params.row.EquipmentName;params.row.LeverageServiceId!==0&&($scope.isEdit=!0,$scope.LSQuoteStatusId=params.row.LSQuoteStatusId,$scope.LSQuoteAmount=params.row.LSQuoteAmount,$scope.LSQuoteReference=params.row.LSQuoteReference,$scope.LSQuoteStatusId=params.row.LSQuoteStatusId,$scope.LSQuoteComment=params.row.LSQuoteComment);$scope.LeverageServiceStatus=function(){var _url="/Lookup/GetLookupByName?lId="+params.languageId+"&lName=LeverageServiceStatus";$http.get(_url).then(function(response){$scope.QuoteStatusDDL=response.data})}();$scope.LeverageServiceDDL=params.data;$scope.save=function(){if($scope.LSQuoteReference!=="undefined"||$scope.LSQuoteAmount!=="undefined"||$scope.LSQuoteStatusId!=="undefined")$scope.Leverageservice={JobEquipmentId:params.row.JobEquipmentId,LSQuoteReference:$scope.LSQuoteReference,LSQuoteAmount:$scope.LSQuoteAmount,LSQuoteStatusId:$scope.LSQuoteStatusId,LSQuoteComment:$scope.LSQuoteComment,LeverageServices:$scope.LeverageServiceDDL},$http.post("/leverage/Create",JSON.stringify($scope.Leverageservice)).then(function(response){var fileUpload,files;response&&(fileUpload=$("#files").get(0),$scope.aId=response.data,files=fileUpload.files,files.length>0?$scope.uploadDocument():alertFactory.setMessage({msg:"Data saved Successfully."}))},function(response){response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})});else alertFactory.setMessage({type:"warning",msg:"Invalid User.",exc:"Please fill mandatory fields"})};$scope.uploadDocument=function(){var fileUpload=$("#files").get(0),files=fileUpload.files,data=new FormData,i;if($scope.aId){for(i=0;i<files.length;i++)data.append(files[i].name,files[i]);$.ajax({type:"POST",url:"/leverage/UploadFilesAjax",contentType:!1,processData:!1,headers:{aId:$scope.aId,Type:"Leverage"},data:data,success:function(){alertFactory.setMessage({msg:"Data saved successfully."});$("#files").val("");$uibModalInstance.close($scope.rowData)},error:function(){alertFactory.setMessage({type:"warning",msg:"Error upload document please upload attachment again."})}})}};$scope.validFormat=!1;$scope.uploadImageStart=function(){$scope.validFormat=!1;var fileUpload=$("#files").get(0),files=fileUpload.files,_files=$.map($("#files").prop("files"),function(val){return val.name});angular.forEach(_files,function(filename){var filext=filename.substring(filename.lastIndexOf(".")+1);filext=filext.toLowerCase()});fileUpload?$timeout(function(){$scope.readURL(fileUpload);$scope.validFormat=!0},10):$timeout(function(){alertFactory.setMessage({type:"warning",msg:"Upload valid Image Format"});$scope.validFormat=!1;$("#files").val("")},10)};$scope.readURL=function(input){var i,reader;for($scope.thumb=[],i=0;i<input.files.length;i++)input.files&&input.files[i]&&(reader=new FileReader,reader.onload=function(e){$scope.thumb.push(e.target.result)},reader.readAsDataURL(input.files[i]))};$scope.DirtyValues=function(row){row.isDirty=!0;console.log($scope.LeverageServiceDDL)};$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$scope.comments="";$uibModalInstance.dismiss("cancel");$scope.isProcess=!0}});