app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.cellNav","ui.grid.pinning","ui.grid.exporter");app.controller("skfCtrl",function($scope,$filter,uiGridConstants,$http,$uibModal,languageFactory,alertFactory,clientFactory,$timeout){function getCellClass(grid,row){return row.uid===highlightRow?"highlight":""}var _columns,highlightRow;$scope.startIndex=1;$scope.isEdit=!1;$scope.isCreate=!1;$scope.isSearch=!0;$scope.readOnlyPage=!1;$scope.formatters={};$scope.language=null;$scope.B_Active="All";_columns=[{name:"sno",displayName:"#",width:"4%",minWidth:50,cellClass:getCellClass,enableFiltering:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"ActualRepairCost",displayName:"Avoided PM Cost ($)",cellClass:getCellClass,enableColumnResizing:!0,width:"16%",minWidth:100},{name:"DownTimeCost",displayName:"Down Time Cost ($)",cellClass:getCellClass,enableColumnResizing:!0,width:"10%",minWidth:100},{name:"TrueSavingsCost",displayName:"True Savings",cellClass:getCellClass,enableColumnResizing:!0,width:"10%",minWidth:100},{name:"TrueSavingsHrs",displayName:"True Savings Hrs",cellClass:getCellClass,enableColumnResizing:!0,width:"10%",minWidth:100},{name:"CreatedBy",displayName:"Action Taken",cellClass:getCellClass,enableColumnResizing:!0,width:"16%",minWidth:100},{name:"ReportDate",displayName:"Date of Report",enableColumnResizing:!0,enableCellEdit:!1,minWidth:80,width:"18%",cellFilter:"date:'dd/MM/yyyy'",cellClass:getCellClass,aggregationType:uiGridConstants.aggregationTypes.count,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total Count: {{col.getAggregationValue() | number:0 }}<\/div>'},{name:"Action",enableFiltering:!1,enableSorting:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.editRow(row.entity)" <i class="fa fa-pencil-square-o icon-space-before" tooltip-append-to-body="true" uib-tooltip="Edit Avoided Planned Maintenance" tooltip-class="customClass"><\/i><\/a><a ng-click="grid.appScope.FileUpload(row)"><i class="fa fa-file-picture-o icon-space-before" tooltip-append-to-body="true" uib-tooltip="View Attachment" tooltip-class="customClass"><\/i><\/a><\/div>',width:"13%",minWidth:100}];$scope.resetForm=function(){setTimeout(function(){for(var elements=document.getElementsByName("userForm")[0].querySelectorAll(".has-error"),i=0;i<elements.length;i++)elements[i].className=elements[i].className.replace(/\has-error\b/g,"")},500)};$scope.clearModal=function(){$scope.readOnlyPage=!1;$scope.isProcess=!1;$scope.resetForm()};$scope.clearOut=function(){$scope.clearValue()};var date=new Date,y=date.getFullYear(),m=date.getMonth(),d=date.getDate();$scope.clearValue=function(){$scope.L_FailureReport={ReportFromDate:new Date(y,m,d-30),ReportToDate:new Date}};$scope.clearValue();highlightRow=null;$scope.columns=angular.copy(_columns);$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)};gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus "&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_FailureReport.xlsx",exporterExcelSheetName:"EMaintenance_FailureReport",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.loadData=function(){$scope.gridOpts.data=[];$scope.isPageLoad=!0;$scope.L_FailureReport={ReportFromDate:$filter("date")($scope.L_FailureReport.ReportFromDate,"yyyy-MM-dd 00:00:00"),ReportToDate:$filter("date")($scope.L_FailureReport.ReportToDate,"yyyy-MM-dd 00:00:00"),LanguageId:$scope.language.LanguageId,ClientSiteId:$scope.ClientSiteId,FailureReportHeaderId:0,ReportType:"APM"};$http.post("/AvoidedPlannedMaintenance/GetAvoidPlannedMaintenance",JSON.stringify($scope.L_FailureReport)).then(function(response){response.data&&($scope.gridOpts.data=response.data,$scope.L_FailureReport.ReportFromDate=new Date($scope.L_FailureReport.ReportFromDate),$scope.L_FailureReport.ReportToDate=new Date($scope.L_FailureReport.ReportToDate),angular.forEach($scope.gridOpts.data,function(val,i){val.sno=i+1}))},function(response){$scope.alerts.push({type:"warning",msg:String(response.data.message)})})};$scope.selectClient=function(){var clientInfo=sessionStorage.getItem("clientInfo"),_client;clientFactory.setClient(clientInfo);clientInfo==null?sessionStorage.setItem("isClientSite","yes"):clientInfo&&clientInfo!="undefined"&&(_client=JSON.parse(clientInfo),$scope.ClientSiteId=_client.ClientSiteId)};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!=oldValue&&newValue&&($scope.language=newValue,$scope.selectClient(),$scope.loadData())});$scope.editRow=function(row){var modalInstance=$uibModal.open({templateUrl:"skfAvoidedplmaint.html",controller:"skfAvoidedplmaintCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return row?{row:row,languageId:$scope.language.LanguageId,ClientSiteId:$scope.ClientSiteId,DriveUnitList:$scope.DriveUnitList,IntermediateUnitList:$scope.IntermediateUnitList,DrivenUnitList:$scope.DrivenUnitList,FailureReportHeaderId:$scope.FailureReportHeaderId,isEdit:!0}:{languageId:$scope.language.LanguageId,ClientSiteId:$scope.ClientSiteId,isEdit:!1}}}});modalInstance.result.then(function(data){data&&$scope.loadData()},function(){})};$scope.FileUpload=function(row){$scope.aId=row.entity.FailureReportHeaderId;var modalInstance=$uibModal.open({templateUrl:"skfAttachmentModal.html",controller:"skfAttachmentCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{languageId:$scope.language.LanguageId,aId:row.entity.FailureReportHeaderId,Type:"AvoidedPlannedMaintenence"}}}});modalInstance.result.then(function(){},function(){})}});app.controller("skfAvoidedplmaintCtrl",function($scope,$http,$filter,$uibModal,$uibModalInstance,params,uiGridConstants,alertFactory,$timeout){var _params=params;$scope.isEdit=params.isEdit;$scope.ReportDate=new Date;params.isEdit&&($scope.formatters={},$scope.row=params.row,$scope.languageId=params.languageId,$scope.ReportDate=new Date($scope.row.ReportDate),$scope.EquipmentName=params.row.EquipmentName,$scope.PlantAreaName=params.row.PlantAreaName,$scope.FailureModeId=params.FailureModeId);$scope.loadEq=function(){typeof $scope.AreaId=="undefined"&&($scope.AreaId=0);typeof $scope.SystemId=="undefined"&&($scope.SystemId=0);var _url="/equipment/loadEqbyPlantAreaSystem?PlId="+$scope.PlantAreaId+"&ArId="+$scope.AreaId+"&SyId="+$scope.SystemId;$http.get(_url).then(function(response){$scope.EqDDL=response.data})};$scope.loadPlant=function(){var _url="/Plant/GetPlantByStatus?lId="+params.languageId+"&csId="+params.ClientSiteId+"&status=Y";$http.get(_url).then(function(response){$scope.PlantDDL=response.data})}();$scope.loadArea=function(data){var _url="/taxonomy/GetLoadListItem?Type=Area&lId="+params.languageId+"&sId="+data+"&sId1=0";$http.get(_url).then(function(response){$scope.AreaDDL=response.data;$timeout(function(){$scope.loadEq()},10)});$scope.DriveUnitList=[];$scope.IntermediateUnitList=[];$scope.DrivenUnitList=[]};$scope.loadSystem=function(data){var _url="/taxonomy/GetLoadListItem?Type=System&lId="+params.languageId+"&sId="+data+"&sId1=0";$http.get(_url).then(function(response){$scope.SystemDDL=response.data;$timeout(function(){$scope.loadEq()},10)});$scope.DriveUnitList=[];$scope.IntermediateUnitList=[];$scope.DrivenUnitList=[]};$scope.loadAsset=function(data){var _url="/Equipment/GetFailureReportDetail?eqId="+data;$http.get(_url).then(function(response){angular.forEach(response.data,function(val){$scope.DriveUnitList=JSON.parse(val.DriveUnitList);$scope.IntermediateUnitList=JSON.parse(val.IntermediateUnitList);$scope.DrivenUnitList=JSON.parse(val.DrivenUnitList)})})};$scope.uploadDocument=function(id){var fileUpload=$("#files").get(0),files=fileUpload.files,data=new FormData,i;if(id){for(i=0;i<files.length;i++)data.append(files[i].name,files[i]);$.ajax({type:"POST",url:"/AvoidedPlannedMaintenance/UploadFiles",contentType:!1,processData:!1,headers:{aId:id,type:"AvoidedPlannedMaintenence"},data:data,success:function(){alertFactory.setMessage({msg:"Data saved successfully."});$("#files").val("")},error:function(){alertFactory.setMessage({type:"warning",msg:"Error upload document please upload attachment again."})}})}};$scope.validFormat=!1;$scope.uploadImageStart=function(){$scope.validFormat=!1;var fileUpload=$("#files").get(0),files=fileUpload.files,_files=$.map($("#files").prop("files"),function(val){return val.name});angular.forEach(_files,function(filename){var filext=filename.substring(filename.lastIndexOf(".")+1);filext=filext.toLowerCase()});fileUpload?$timeout(function(){$scope.readURL(fileUpload);$scope.validFormat=!0},10):$timeout(function(){alertFactory.setMessage({type:"warning",msg:"Upload valid Image Format"});$scope.validFormat=!1;$("#files").val("")},10)};$scope.readURL=function(input){var i,reader;for($scope.thumb=[],i=0;i<input.files.length;i++)input.files&&input.files[i]&&(reader=new FileReader,reader.onload=function(e){$scope.thumb.push(e.target.result)},reader.readAsDataURL(input.files[i]))};$scope.save=function(){var FailureReportList=[],drivelength,interlength,drivenlength,_postdata,postUrl;if($scope.DriveUnitList)for(drivelength=$scope.DriveUnitList.length,i=0;i<drivelength;i++)if($scope.DriveUnitList[i].Descriptions!=""||$scope.DriveUnitList[i].DActualRepairCost!=null||$scope.DriveUnitList[i].DActualOutageTime!=null)if($scope.DriveUnitList[i].Descriptions!=""&&$scope.DriveUnitList[i].DActualRepairCost!=null&&$scope.DriveUnitList[i].DActualOutageTime!=null)$scope.isDriveValidate=!0,$scope.DriveUnitList[i].DActive="Y",FailureReportList.push($scope.DriveUnitList[i]);else{$scope.isDriveValidate=!1;break}else $scope.isDriveValidate=!0;else $scope.isDriveValidate=!0;if($scope.IntermediateUnitList)for(interlength=$scope.IntermediateUnitList.length,i=0;i<interlength;i++)if($scope.IntermediateUnitList[i].Descriptions!=""||$scope.IntermediateUnitList[i].DActualRepairCost!=null||$scope.IntermediateUnitList[i].DActualOutageTime!=null)if($scope.IntermediateUnitList[i].Descriptions!=""&&$scope.IntermediateUnitList[i].DActualRepairCost!=null&&$scope.IntermediateUnitList[i].DActualOutageTime!=null)$scope.isInterValidate=!0,$scope.IntermediateUnitList[i].DActive="Y",FailureReportList.push($scope.IntermediateUnitList[i]);else{$scope.isInterValidate=!1;break}else $scope.isInterValidate=!0;else $scope.isInterValidate=!0;if($scope.DrivenUnitList)for(drivenlength=$scope.DrivenUnitList.length,i=0;i<drivenlength;i++)if($scope.DrivenUnitList[i].Descriptions!=""||$scope.DrivenUnitList[i].DActualRepairCost!=null||$scope.DrivenUnitList[i].DActualOutageTime!=null)if($scope.DrivenUnitList[i].Descriptions!=""&&$scope.DrivenUnitList[i].DActualRepairCost!=null&&$scope.DrivenUnitList[i].DActualOutageTime!=null)$scope.isDrivenValidate=!0,$scope.DrivenUnitList[i].DActive="Y",FailureReportList.push($scope.DrivenUnitList[i]);else{$scope.isDrivenValidate=!1;break}else $scope.isDrivenValidate=!0;else $scope.isDrivenValidate=!0;_postdata={ClientSiteId:params.ClientSiteId,EquipmentId:$scope.EquipmentId,ReportType:"APM",ReportDate:$filter("date")($scope.ReportDate,"yyyy-MM-dd 00:00:00"),Active:"Y",FailureReportList:FailureReportList};$scope.isProcess=!0;postUrl="/AvoidedPlannedMaintenance/Update";$scope.isDriveValidate&&$scope.isInterValidate&&$scope.isDrivenValidate&&FailureReportList.length>0?$http.post(postUrl,JSON.stringify(_postdata)).then(function(response){response.data&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):(alertFactory.setMessage({msg:"Data Updated Successfully."}),$uibModalInstance.close("Ok"),angular.forEach(response.data,function(val){$scope.id=val.FailureReportHeaderId}),$scope.uploadDocument($scope.id)));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})}):alertFactory.setMessage({type:"warning",msg:"Please Fill Atleast One Row"})};$scope.loadData=function(){$scope.row&&($scope.row.DriveUnitList&&($scope.DriveUnitList=JSON.parse($scope.row.DriveUnitList)),$scope.row.IntermediateUnitList&&($scope.IntermediateUnitList=JSON.parse($scope.row.IntermediateUnitList)),$scope.row.DrivenUnitList&&($scope.DrivenUnitList=JSON.parse($scope.row.DrivenUnitList)))}();$scope.update=function(){var FailureReportList=[],drivelength,interlength,drivenlength,_postdata,postUrl;if($scope.DriveUnitList)for(drivelength=$scope.DriveUnitList.length,i=0;i<drivelength;i++)if($scope.DriveUnitList[i].Descriptions!=""||$scope.DriveUnitList[i].DActualRepairCost!=null||$scope.DriveUnitList[i].DActualOutageTime!=null)if($scope.DriveUnitList[i].Descriptions!=""&&$scope.DriveUnitList[i].DActualRepairCost!=null&&$scope.DriveUnitList[i].DActualOutageTime!=null)$scope.isDriveValidate=!0,$scope.DriveUnitList[i].DActive="Y",FailureReportList.push($scope.DriveUnitList[i]);else{$scope.isDriveValidate=!1;break}else $scope.isDriveValidate=!0;else $scope.isDriveValidate=!0;if($scope.IntermediateUnitList)for(interlength=$scope.IntermediateUnitList.length,i=0;i<interlength;i++)if($scope.IntermediateUnitList[i].Descriptions!=""||$scope.IntermediateUnitList[i].DActualRepairCost!=null||$scope.IntermediateUnitList[i].DActualOutageTime!=null)if($scope.IntermediateUnitList[i].Descriptions!=""&&$scope.IntermediateUnitList[i].DActualRepairCost!=null&&$scope.IntermediateUnitList[i].DActualOutageTime!=null)$scope.isInterValidate=!0,$scope.IntermediateUnitList[i].DActive="Y",FailureReportList.push($scope.IntermediateUnitList[i]);else{$scope.isInterValidate=!1;break}else $scope.isInterValidate=!0;else $scope.isInterValidate=!0;if($scope.DrivenUnitList)for(drivenlength=$scope.DrivenUnitList.length,i=0;i<drivenlength;i++)if($scope.DrivenUnitList[i].Descriptions!=""||$scope.DrivenUnitList[i].DActualRepairCost!=null||$scope.DrivenUnitList[i].DActualOutageTime!=null)if($scope.DrivenUnitList[i].Descriptions!=""&&$scope.DrivenUnitList[i].DActualRepairCost!=null&&$scope.DrivenUnitList[i].DActualOutageTime!=null)$scope.isDrivenValidate=!0,$scope.DrivenUnitList[i].DActive="Y",FailureReportList.push($scope.DrivenUnitList[i]);else{$scope.isDrivenValidate=!1;break}else $scope.isDrivenValidate=!0;else $scope.isDrivenValidate=!0;_postdata={FailureReportHeaderId:params.row.FailureReportHeaderId,ClientSiteId:params.ClientSiteId,EquipmentId:params.row.EquipmentId,ReportType:"APM",ReportDate:$filter("date")($scope.ReportDate,"yyyy-MM-dd 00:00:00"),Active:"Y",FailureReportList:FailureReportList};$scope.isProcess=!0;postUrl="/AvoidedPlannedMaintenance/Update";$scope.isDriveValidate&&$scope.isInterValidate&&$scope.isDrivenValidate&&FailureReportList.length>0?$http.post(postUrl,JSON.stringify(_postdata)).then(function(response){response.data&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):(alertFactory.setMessage({msg:"Data Updated Successfully."}),$uibModalInstance.close("Ok"),angular.forEach(response.data,function(val){$scope.id=val.FailureReportHeaderId}),$scope.uploadDocument($scope.id)));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})}):alertFactory.setMessage({type:"warning",msg:"Please fill all the fields"})};$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$scope.comments="";$uibModalInstance.dismiss("cancel");$scope.isProcess=!0}});app.controller("skfAttachmentCtrl",function($scope,$uibModalInstance,params,$timeout,$http){$scope.iframe=!1;$scope.noAttachment=!1;$scope.previewImg=!0;$scope.uploadFile=!0;$scope.languageId=params.languageId;$scope.aid=params.aId;$scope.Type=params.Type;$scope.AssetName=params.AssetName;$scope.attach=function(){$scope.attachments=$scope.rowData.attachment};$scope.saveDoc=function(){$scope.uploadDocument()};$scope.getAttachment=function(){var _url="/FailureReport/GetAttachmentById?frhId="+$scope.aid+"&type="+$scope.Type+"&at=Attachment&status=Y";$http.get(_url).then(function(response){$scope.attachment=response.data;angular.forEach($scope.attachment,function(val){val.attachId=val.FailureReportAttachId;val.type="AvoidedPlannedMaintenence"});$scope.attachment.length<=0&&($scope.noAttachment=!0);$scope.attImage="";$scope.previewImg=!0;$scope.FileName=""})};$scope.getAttachment();$scope.showAttach=function(data,index){$scope.docindex=index;var _url="/FailureReport/GetAttachmentById?frhId="+$scope.aid+"&type="+$scope.Type+"&at=Attachment&status=Y";$http.get(_url).then(function(response){$scope.attach=response.data;angular.forEach($scope.attach,function(val){data==val.FailureReportAttachId&&($scope.FileName=val.FileName,$scope.attImage=val.PhysicalPath,$scope.previewImg=!1)})})};$scope.removeAttachment=function(AttachmentId,Type){var _url="/FailureReport/DeleteAttachment?Type="+Type+"&AttachmentId="+AttachmentId;$http.post(_url).then(function(){$timeout(function(){$scope.getAttachment();$scope.attImage="";$scope.FileName="";$scope.previewImg=!0},50)})};$scope.readURL=function(input){var i,reader;for($scope.thumb=[],i=0;i<input.files.length;i++)input.files&&input.files[i]&&(reader=new FileReader,reader.onload=function(e){$scope.thumb.push(e.target.result)},reader.readAsDataURL(input.files[i]))};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});