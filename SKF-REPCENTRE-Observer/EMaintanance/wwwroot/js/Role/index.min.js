app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.pinning","ui.grid.exporter","dndLists");app.controller("skfCtrl",function($scope,$filter,uiGridConstants,$http,$uibModal,languageFactory,alertFactory,$timeout){function getCellClass(grid,row){return row.uid===highlightRow?"highlight":""}var _columns,highlightRow;$scope.startIndex=1;$scope.readOnlyPage=!1;$scope.formatters={};$scope.language=null;$scope.S_Status="ALL";_columns=[{name:"sno",displayName:"#",width:"4%",minWidth:50,cellClass:getCellClass,enableFiltering:!1,enableSorting:!1,enableHiding:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"RoleName",displayName:"Role Name",cellClass:getCellClass,enableColumnResizing:!0,width:"25%",minWidth:150,aggregationHideLabel:!1,aggregationType:uiGridConstants.aggregationTypes.count,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total Count: {{col.getAggregationValue() | number:0 }}<\/div>'},{name:"Descriptions",displayName:"Descriptions",cellClass:getCellClass,enableColumnResizing:!0,width:"35%",minWidth:300},{name:"Active",displayName:"Status",cellClass:getCellClass,cellTemplate:'<div class="status"> {{ row.entity.Active == "Y" ? "&nbsp;Active" : "&nbsp;Inactive" }}<\/div>',filter:{type:uiGridConstants.filter.SELECT,selectOptions:[{value:"Y",label:"Active"},{value:"N",label:"Inactive"}]},width:"18%",minWidth:100},{name:"Action",enableFiltering:!1,enableSorting:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.editRow(row.entity)" <i class="fa fa-pencil-square-o icon-space-before" tooltip-append-to-body="true" uib-tooltip="Edit Role" tooltip-class="customClass"><\/i><\/a><a ng-click="grid.appScope.roleProgramPrivilage(row.entity)" <i class="fa fa-link icon-space-before" tooltip-append-to-body="true" uib-tooltip="Role Program Privilege Relation" tooltip-class="customClass"><\/i><\/a><\/div>',width:"16%",minWidth:100}];$scope.editRow=function(row){$scope.isEdit=!0;$scope.clearModal();$scope.Role=row;$scope.isCreate=!1};$scope.clearOut=function(){$scope.isEdit=!1;$scope.clearModal()};$scope.resetForm=function(){setTimeout(function(){for(var elements=document.getElementsByName("userForm")[0].querySelectorAll(".has-error"),i=0;i<elements.length;i++)elements[i].className=elements[i].className.replace(/\has-error\b/g,"")},500)};$scope.clearModal=function(){$scope.readOnlyPage=!1;$scope.isProcess=!1;$scope.Role={RoleId:0,RoleName:null,Internal:"N",Descriptions:null,Active:null};$scope.resetForm()};$scope.clearValue=function(){$scope.S_Status="ALL"};$scope.clearValue();$scope.createToggle=function(){$scope.isCreate=!0;$scope.isSearch=!1;$scope.clearOut()};$scope.columns=angular.copy(_columns);highlightRow=null;$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)};gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus "&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_Role.xlsx",exporterExcelSheetName:"EMaintenance_Role",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.loadData=function(){$scope.gridOpts.data=[];$scope.isPageLoad=!0;var _status=$scope.ClientStatus_Search&&$scope.ClientStatus_Search!=""?$scope.ClientStatus_Search:0,_url="/Role/GetRoleByStatus?&status="+$scope.S_Status;$http.get(_url).then(function(response){$scope.gridOpts.data=response.data;angular.forEach($scope.gridOpts.data,function(val,i){val.sno=i+1})})};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!=oldValue&&newValue&&($scope.language=newValue,$scope.loadData(),$scope.createToggle())});$scope.save=function(){if($scope.userForm.$valid&&!$scope.isProcess&&!$scope.readOnlyPage){$scope.isProcess=!0;$http.post("/Role/Create",JSON.stringify($scope.Role)).then(function(response){response.data&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):(alertFactory.setMessage({msg:"Data saved Successfully."}),$scope.createToggle(),$scope.loadData()));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})}};$scope.update=function(){if($scope.userForm.$valid&&!$scope.isProcess&&!$scope.readOnlyPage){$scope.isProcess=!0;$http.post("/Role/Update",JSON.stringify($scope.Role)).then(function(response){response.data&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):(alertFactory.setMessage({msg:"Data updated Successfully."}),$scope.loadData()));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})}};$scope.roleProgramPrivilage=function(row){$http.get("/RolePrgPrivRel/GetRolePrgPrivAccess?rId="+row.RoleId+"&lId="+$scope.language.LanguageId).then(function(response){var modalInstance=$uibModal.open({templateUrl:"skfProgramPrivilageModal.html",controller:"skfProgramPrivilageCtrl",windowClass:"failure-report-modal",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row,data:response.data}}}});modalInstance.result.then(function(){$scope.loadData()},function(){$scope.loadData()})})}});app.controller("skfProgramPrivilageCtrl",function($scope,$http,$uibModalInstance,params,alertFactory){$scope.rowData=params.row;var _data=JSON.parse(params.data[0].RolePrgPrivilageRelation)[0];$scope.models=[{listName:"Available",cssClass:"warning",items:_data.Available?_data.Available:[],dragging:!1},{listName:"Associated",cssClass:"success",items:_data.Associated?_data.Associated:[],dragging:!1}];$scope.getSelectedItemsIncluding=function(list,item){return item.selected=!0,list.items.filter(function(item){return item.selected})};$scope.btnright=!1;$scope.btnleft=!1;$scope.setSelected=function(list,item){item.selected=!item.selected;list.selectFlag=!(list.items.length==list.items.filter(function(item){return item.selected}).length);$scope.btnright=item.selected&&list.listName=="Available"?!0:!1;$scope.btnleft=item.selected&&list.listName=="Associated"?!0:!1};$scope.onDragstart=function(list,event){if(list.dragging=!0,event.dataTransfer.setDragImage){var img=new Image;img.src="images/ic_content_copy_black_24dp_2x.png";event.dataTransfer.setDragImage(img,0,0)}};$scope.onDrop=function(list,items,index){return angular.forEach(items,function(item){angular.forEach(item.Privileges,function(pre){pre.Active="N";list.listName=="Associated"&&pre.PrivilegeName=="View"&&(pre.Active="Y")});item.selected=!1}),list.selectFlag=!0,list.items=list.items.slice(0,index).concat(items).concat(list.items.slice(index)),$scope.btnright=!1,$scope.btnleft=!1,!0};$scope.onMoved=function(list){list.selectFlag=!0;list.items=list.items.filter(function(item){return!item.selected})};$scope.ShuttleRight=function(list){$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,angular.forEach($scope.models,function(data,_i){_i==1?(data.items.push(item),angular.forEach(item.Privileges,function(pre){pre.Active="N";pre.PrivilegeName=="View"&&(pre.Active="Y")})):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.ShuttleRightAll=function(list){angular.forEach(list.items,function(item){item.selected=!0});$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,angular.forEach($scope.models,function(data,_i){_i==1?(data.items.push(item),angular.forEach(item.Privileges,function(pre){pre.Active="N";pre.PrivilegeName=="View"&&(pre.Active="Y")})):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.ShuttleLeft=function(list){$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,item.HideProgram="N",angular.forEach($scope.models,function(data,_i){_i==0?(data.items.push(item),angular.forEach(item.Privileges,function(pre){pre.Active="N"})):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.ShuttleLeftAll=function(list){angular.forEach(list.items,function(item){item.selected=!0});$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,item.HideProgram="N",angular.forEach($scope.models,function(data,_i){_i==0?(data.items.push(item),angular.forEach(item.Privileges,function(pre){pre.Active="N"})):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.privilageCheck=function(item){item.selected=!item.selected};$scope.save=function(){var postData={},postUrl;postData.RoleId=_data.RoleId;postData.Programs=[];angular.forEach($scope.models,function(m){angular.forEach(m.items,function(item){item.Active=m.listName=="Associated"?"Y":"N";postData.Programs.push(item)})});$scope.isProcess||($scope.isProcess=!0,postUrl="/RolePrgPrivRel/Create",$http.post(postUrl,JSON.stringify(postData)).then(function(response){response.data&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):response.data.isException?alertFactory.setMessage({type:"warning",msg:response.data.message}):alertFactory.setMessage({type:"success",msg:"Data updated Successfully."}));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})}))};$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});