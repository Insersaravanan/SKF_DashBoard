app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.pinning","ui.grid.exporter");app.controller("skfCtrl",function($scope,$filter,uiGridConstants,$http,$uibModal,languageFactory,alertFactory,clientFactory,$timeout){function getCellClass(grid,row){return row.uid===highlightRow?"highlight":""}var _column,highlightRow;$scope.startIndex=1;$scope.readOnlyPage=!1;$scope.formatters={};$scope.language=null;$scope.stage="";$scope.equipmentListActive=!0;$scope.isSelect=!1;$scope.ReportDate=new Date;$scope.next=function(stage){$scope.assetDetailsActive=!1;$scope.equipmentListActive=!1;$scope.assetActive=!1;(stage=="stage2"||stage=="stage1"||stage=="stage0")&&(stage=="stage2"?$scope.assetDetailsActive=!0:stage=="stage1"?$scope.assetActive=!0:($scope.equipmentListActive=!0,$scope.loadData()));$scope.stage=stage};_column=[{name:"sno",displayName:"#",width:"4%",minWidth:50,enableFiltering:!1,enableSorting:!1,enableCellEdit:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"JobNumber",displayName:"Job Number",enableColumnResizing:!0,enableCellEdit:!1,width:"12%",minWidth:100,cellClass:getCellClass,aggregationHideLabel:!1,aggregationType:uiGridConstants.aggregationTypes.count,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total Count: {{col.getAggregationValue() | number:0 }}<\/div>'},{name:"WorkNotificationNumber",displayName:"Work Notification Number",enableColumnResizing:!0,enableCellEdit:!1,width:"15%",minWidth:100,cellClass:getCellClass},{name:"PlantAreaName",displayName:"Plant Name",enableColumnResizing:!0,enableCellEdit:!1,minWidth:80,width:"12%",cellFilter:"date:'dd/MM/yyyy'",cellClass:getCellClass},{name:"EquipmentName",displayName:"Equipment Name",enableColumnResizing:!0,enableCellEdit:!1,minWidth:80,width:"12%",cellFilter:"date:'dd/MM/yyyy'",cellClass:getCellClass},{name:"ConditionName",displayName:"Equipment Condition Code",enableColumnResizing:!0,enableCellEdit:!1,minWidth:100,width:"15%",cellFilter:"date:'dd/MM/yyyy'",cellClass:getCellClass},{name:"DataCollectionDate",displayName:"Date",cellClass:getCellClass,enableColumnResizing:!0,width:"10%",minWidth:100,cellFilter:"date:'dd/MM/yyyy'"},{name:"StatusName",displayName:"Status",enableColumnResizing:!0,enableCellEdit:!1,width:"8%",minWidth:100,cellClass:getCellClass},{name:"Action",enableFiltering:!1,enableSorting:!1,enableCellEdit:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.loadAssetByEq(row.entity)"<i class="fa fa-compass icon-space-before" tooltip-append-to-body="true" uib-tooltip="Asset" tooltip-class="customClass"><\/i><\/a><a ng-click="grid.appScope.Status(row.entity)" ng-class="{disable:row.entity.StatusCode == \'CL\'}"><i class="fa fa-sun-o icon-space-before" tooltip-append-to-body="true" uib-tooltip="Status" tooltip-class="customClass"><\/i><\/a><\/div>',width:"10%",minWidth:100}];$scope.resetForm=function(){setTimeout(function(){for(var elements=document.getElementsByName("userForm")[0].querySelectorAll(".has-error"),i=0;i<elements.length;i++)elements[i].className=elements[i].className.replace(/\has-error\b/g,"")},500)};var date=new Date,y=date.getFullYear(),m=date.getMonth(),d=date.getDate();$scope.clearModal=function(){$scope.readOnlyPage=!1;$scope.isProcess=!1;$scope.resetForm();$scope.EqSearch={FromDate:new Date(y,m,d-30),ToDate:new Date,statusId:0}}();$scope.selectClient=function(){var clientInfo=sessionStorage.getItem("clientInfo"),modalInstance,_client;clientFactory.setClient(clientInfo);clientInfo==null?(modalInstance=$uibModal.open({templateUrl:"skfClientInfoModal.html",controller:"skfClientInfoModalCtrl",size:"md",backdrop:"static",keyboard:!1,resolve:{params:function(){return{languageId:$scope.language.LanguageId,ClientName:$scope.clientName}}}}),modalInstance.result.then(function(data){data&&(sessionStorage.setItem("clientInfo",JSON.stringify(data)),clientFactory.setClient(data),window.location.reload())},function(){})):clientInfo&&clientInfo!="undefined"&&(_client=JSON.parse(clientInfo),$scope.ClientSiteId=_client.ClientSiteId)};$scope.columns=angular.copy(_column);$scope.loadData=function(data){$scope.EqSearch.ToDate=$scope.EqSearch.ToDate?$filter("date")($scope.EqSearch.ToDate,"yyyy-MM-dd"):null;$scope.EqSearch.FromDate=$scope.EqSearch.FromDate?$filter("date")($scope.EqSearch.FromDate,"yyyy-MM-dd"):null;data&&$scope.next("stage0");var getdata={FromDate:$scope.EqSearch.FromDate,ToDate:$scope.EqSearch.ToDate,ClientSiteId:$scope.ClientSiteId,LanguageId:$scope.language.LanguageId,StatusId:$scope.EqSearch.statusId};$http.post("/WorkNotification/GetWorkNotificationByStatus",JSON.stringify(getdata)).then(function(response){$scope.gridOpts.data=response.data;$scope.EqSearch.FromDate=new Date($scope.EqSearch.FromDate);$scope.EqSearch.ToDate=new Date($scope.EqSearch.ToDate);angular.forEach($scope.gridOpts.data,function(val){val.StatusCode==="OP"?val.Status==="N":val.Status==="Y";data&&val.WNEquipmentId===data&&$scope.Status(val)})})};$scope.LoadWorkNotificatinStatus=function(){$scope.WorkNotificatinStatusDDL=[];$scope.defaultWorkNotificatinStatus={LookupId:null,LValue:"--ALL--"};var _url="/Lookup/GetLookupByName?lId="+$scope.language.LanguageId+"&lName=WorkNotificationStatus";$http.get(_url).then(function(response){$scope.WorkNotificatinStatusDDL=response.data;$scope.WorkNotificatinStatusDDL.splice(0,0,$scope.defaultWorkNotificatinStatus)})};$scope.DownloadWorkNotificationExcelReport=function(){if($scope.smReport={ClientSiteId:$scope.ClientSiteId,FromDate:$filter("date")($scope.EqSearch.FromDate,"yyyy-MM-dd"),ToDate:$filter("date")($scope.EqSearch.ToDate,"yyyy-MM-dd"),LanguageId:$scope.language.LanguageId,Statusid:$scope.EqSearch.statusId},$scope.gridOpts.data.length>0){angular.forEach($scope.WorkNotificatinStatusDDL,function(val){$scope.EqSearch.statusId===val.LookupId&&($scope.LValue=val.LValue)});$http.post("/WorkNotification/WorkNoficationOpenExcelDownload",JSON.stringify($scope.smReport)).then(function(response){$scope.template=$filter("date")($scope.EqSearch.FromDate,"yyyy-MM-dd")+"-"+$filter("date")($scope.EqSearch.ToDate,"yyyy-MM-dd");$scope.download=response.data;var ws=XLSX.utils.json_to_sheet($scope.download),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,$scope.template+"");XLSX.writeFile(wb,"Emaintenance_"+$scope.LValue+"_WN_"+$scope.template+".xlsx")})}else alertFactory.setMessage({type:"warning",msg:"Data Not Available to Export"})};highlightRow=null;$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)};gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus "&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_JobList.xlsx",exporterExcelSheetName:"EMaintenance_JobList",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!=oldValue&&newValue&&($scope.language=newValue,$scope.selectClient(),$scope.loadData(),$scope.LoadWorkNotificatinStatus())});$scope.Status=function(row){var modalInstance=$uibModal.open({templateUrl:"skfStatus.html",controller:"skfStatusCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row}}}});modalInstance.result.then(function(data){data?$scope.loadData():$scope.loadData()},function(){})};$scope.columns1=[{name:"sno",displayName:"#",width:"4%",cellClass:getCellClass,minWidth:50,enableFiltering:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"AssetName",displayName:"Asset Name",cellClass:getCellClass,enableColumnResizing:!0,enableCellEdit:!1,width:"8%",minWidth:100,aggregationType:uiGridConstants.aggregationTypes.count},{name:"UnitType",displayName:"Unit Type",cellClass:getCellClass,enableColumnResizing:!0,enableCellEdit:!1,width:"8%",minWidth:100},{name:"MeanRepairManHours",displayName:"Total Outage Time(hrs)",cellClass:getCellClass,enableColumnResizing:!0,enableCellEdit:!1,width:"10%",minWidth:100},{name:"DownTimeCostPerHour",displayName:"Down Time Cost $",cellClass:getCellClass,enableColumnResizing:!0,enableCellEdit:!1,width:"10%",minWidth:100},{name:"CostToRepair",displayName:"Cost of Repair $",cellClass:getCellClass,enableColumnResizing:!0,enableCellEdit:!1,width:"10%",minWidth:100},{name:"StatusName",displayName:"Status",cellClass:getCellClass,enableColumnResizing:!0,enableCellEdit:!1,width:"6%",minWidth:200},{name:"ActualRepairCost",displayName:"Repair Cost",enableColumnResizing:!0,width:"10%",minWidth:100,cellClass:getCellClass,cellEditableCondition:function($scope1){return $scope1.row.entity.StatusCode=="OP"?!0:!1},cellTemplate:'<div class="ui-grid-cell-contents grid-checkbox"><input type="text" class="grid-text"  ng-model="row.entity.ActualRepairCost"><\/div>'},{name:"ActualOutageHours",displayName:"Actual Outage",enableColumnResizing:!0,width:"10%",minWidth:100,cellClass:getCellClass,cellEditableCondition:function($scope1){return $scope1.row.entity.StatusCode=="OP"?!0:!1},cellTemplate:'<div class="ui-grid-cell-contents grid-checkbox"><input class="grid-text" type="text" ng-model="row.entity.ActualOutageHours"><\/div>'},{name:"Status",displayName:"Select",enableFiltering:!1,cellClass:getCellClass,headerCellTemplate:'<div class="ui-grid-cell-contents job-user"><span>Select &nbsp;&nbsp<\/span><div><input type="checkbox" class="header-checkbox" ng-click="grid.appScope.SelectAll()" ng-true-value="\'Y\'" ng-false-value="\'N\'"><\/div>',type:"boolean",cellTemplate:'<div class="ui-grid-cell-contents grid-checkbox"><input type="checkbox" ng-disabled="row.entity.StatusCode != \'OP\'" ng-model="row.entity.Status"  tooltip-append-to-body="true" uib-tooltip="Select to cancel the work notification" tooltip-class="customClass" ng-click="grid.appScope.selectUser(row.entity)" ng-true-value="\'Y\'" ng-false-value="\'N\'"><\/div>',width:"7%",minWidth:50},{name:"Action",enableFiltering:!1,enableSorting:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.AssetDetails(row.entity)"<i class="fa fa-info icon-space-before" tooltip-append-to-body="true" uib-tooltip="View" tooltip-class="customClass"><\/i><\/a><\/div>',width:"6%",minWidth:100}];$scope.SelectAll=function(){$scope.filteredRows=$scope.gridApi.core.getVisibleRows($scope.gridApi.grid);$scope.selectAll?$scope.selectAll&&angular.forEach($scope.filteredRows,function(val){val.entity.StatusCode=="OP"&&(val.entity.isDirty=!1,val.entity.Status="N",$scope.selectAll=!1,val.entity.ActualRepairCost=null,val.entity.ActualOutageHours=null)}):angular.forEach($scope.filteredRows,function(val){val.entity.StatusCode=="OP"&&(val.entity.Status="Y",val.entity.isDirty=!0,val.entity.ActualRepairCost=null,val.entity.ActualOutageHours=null,$scope.selectAll=!0)});angular.forEach($scope.gridOpts1.data,function(val){$scope.isSelect=!1;val.StatusCode=="OP"&&val.Status=="Y"&&($scope.isSelect=!0)})};$scope.selectUser=function(row){for(row.isDirty=!0,i=0;i<$scope.gridOpts1.data.length;i++)if($scope.gridOpts1.data[i].StatusCode=="OP"&&$scope.gridOpts1.data[i].Status=="Y"){$scope.isSelect=!0;$scope.gridOpts1.data[i].ActualRepairCost=null;$scope.gridOpts1.data[i].ActualOutageHours=null;break}else $scope.isSelect=!1};$scope.gridOpts1={columnDefs:$scope.columns1,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus "&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_Equipment.xlsx",exporterExcelSheetName:"EMaintenance_Equipment",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.loadAssetByEq=function(row){$scope.rowData=row;$scope.isSave=!1;$scope.gridOpts1.data=[];$scope.worknotificationNumber=row.WorkNotificationNumber;$scope.EqId=row.WNEquipmentId;var _url="/WorkNotification/GetWNEquipUnitAnalysisByEqId?csId="+$scope.ClientSiteId+"&eId="+row.WNEquipmentId+"&lId="+$scope.language.LanguageId;$http.get(_url).then(function(response){$scope.gridOpts1.data=response.data;angular.forEach($scope.gridOpts1.data,function(val){$scope.isSave=!0;val.Status=val.StatusCode=="OP"?"N":"Y"});$scope.next("stage1")})};$scope.AssetDetails=function(row){var modalInstance=$uibModal.open({templateUrl:"skfAssetDatailPopup.html",controller:"skfAssetDatailPopupCtrl",size:"md",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row}}}});modalInstance.result.then(function(){},function(){})};$scope.saveUnitAnalysis=function(){$scope.completeRecord=[];angular.forEach($scope.gridOpts1.data,function(val){val.StatusCode=="OP"&&val.ActualRepairCost!=null&&val.ActualOutageHours!=null&&$scope.completeRecord.push(val)});$http.post("/WorkNotification/SaveWNUnitAnalysis",JSON.stringify($scope.completeRecord)).then(function(response){if(response.data.length==0){for(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):alertFactory.setMessage({msg:"Data Saved Successfully."}),$scope.loadAssetByEq($scope.rowData),i=0;i<$scope.gridOpts1.data.length;i++)if($scope.gridOpts1.data[i].StatusCode=="OP"){$scope.isComplete=!1;break}else $scope.isComplete=!0;$timeout(function(){$scope.isComplete&&$scope.loadData($scope.EqId)},300)}$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})};$scope.cancelUnitAnalysis=function(){$scope.cancelRecord=[];angular.forEach($scope.gridOpts1.data,function(val){val.StatusCode=="OP"&&val.ActualRepairCost==null&&val.ActualOutageHours==null&&val.Status=="Y"&&$scope.cancelRecord.push(val)});var modalInstance=$uibModal.open({templateUrl:"skfCancelPopup.html",controller:"skfCancelCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{}}}});modalInstance.result.then(function(data){if(data){angular.forEach($scope.cancelRecord,function(val){val.CancelRemarks=data});$http.post("/WorkNotification/CancelWNUnitAnalysis",JSON.stringify($scope.cancelRecord)).then(function(response){response.data.length==0&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):alertFactory.setMessage({msg:"Data Saved Successfully."}),$scope.loadAssetByEq($scope.rowData));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})}},function(){})};$scope.OppPopup=function(row){var modalInstance=$uibModal.open({templateUrl:"skfOppPopup.html",controller:"skfOppPopupCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row,languageId:$scope.language.LanguageId,ClientSiteId:$scope.ClientSiteId}}}});modalInstance.result.then(function(){},function(){})};$scope.FileUpload=function(row){$scope.aId=row.UnitAnalysisId;var modalInstance=$uibModal.open({templateUrl:"skfAttachmentModal.html",controller:"skfAttachmentCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{languageId:$scope.language.LanguageId,aId:row.UnitAnalysisId,Type:"UnitAnalysis"}}}});modalInstance.result.then(function(){},function(){})}});app.controller("skfStatusCtrl",function($scope,$http,$filter,$uibModal,$uibModalInstance,params,uiGridConstants,alertFactory){var _params=params;$scope.formatters={};$scope.eqName=params.row.EquipmentName;$scope.WNEquipmentId=params.row.WNEquipmentId;$scope._postdata=[];$scope.save=function(){if($scope.skfForm.$valid&&!$scope.isProcess){var _postdata={WNEquipmentId:$scope.WNEquipmentId,Feedback:$scope.Comments,WNCompletionDate:$filter("date")($scope.JobCompletionDate,"yyyy-MM-dd 00:00:00"),RiAmperage:$scope.RiAmperage,IsAccurate:$scope.IsAccurate};$scope.isProcess=!0;$http.post("/WorkNotification/SaveWorkNoficationFeedBack/",JSON.stringify(_postdata)).then(function(response){response.data[0].Result=="E"?alertFactory.setMessage({type:"warning",msg:response.data[0].ResultText}):alertFactory.setMessage({type:"success",msg:"Status saved Successfully."});$uibModalInstance.close("Ok");$scope.isProcess=!1},function(response){$scope.isProcess=!1;alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})}else alertFactory.setMessage({type:"warning",msg:"Please fill Mandatory(*) Fields"})};$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$scope.comments="";$uibModalInstance.dismiss("cancel");$scope.isProcess=!0}});app.controller("skfOppPopupCtrl",function($scope,$http,$uibModalInstance,params,uiGridConstants,alertFactory){var _params=params;$scope.EqName=params.row.EquipmentName;$scope.formatters={};$scope.languageId=params.languageId;$scope.loadEquipment=function(){var _url="/WorkNotification/GetLoadWNListItem?Type=Equipment&lId="+params.languageId+"&sId=0&csId="+params.ClientSiteId;$http.get(_url).then(function(response){$scope.EquipmentDDL=response.data})}();$scope.loadFailureCause=function(data){var _url="/WorkNotification/GetLoadWNListItem?Type=FailureCause&lId="+params.languageId+"&sId="+data+"&csId="+params.ClientSiteId;$http.get(_url).then(function(response){$scope.FailureCauseDDL=response.data})};$scope.loadFailureMode=function(){var _url="/WorkNotification/GetLoadWNListItem?Type=FailureMode&lId="+params.languageId+"&sId=0&csId="+params.ClientSiteId;$http.get(_url).then(function(response){$scope.FailureModeDDL=response.data})}();$scope.oilProperties=function(){var _url="/WorkNotification/GetListWNEquipmentOpportunity?eqId="+params.row.WNEquipmentId+"&wnNo="+params.row.WorkNotificationNumber+"&lId="+$scope.languageId;$http.get(_url).then(function(response){$scope.OppDDL=response.data;$scope.OppDDL.length<=0?$scope.OppDDL=[{WNOpportunityId:0,WNEquipmentId:params.row.WNEquipmentId,ActualOutageHours:null,ActualRepairCost:null,TrueSavings:0,FailureModeId:null,FailureCauseId:null,Active:"Y"}]:angular.forEach($scope.OppDDL,function(val){$scope.loadFailureCause(val.FailureModeId)})})}();$scope.addMore=function(){$scope.AddData={WNOpportunityId:0,WNEquipmentId:params.row.WNEquipmentId,ActualOutageHours:null,ActualRepairCost:null,TrueSavings:0,FailureModeId:null,FailureCauseId:null,Active:"Y"};$scope.OppDDL.push($scope.AddData)};$scope.removeItem=function(i){angular.forEach($scope.OppDDL,function(val,j){i==j&&val.JobEquipOilPropertiesId!=0?val.Active="N":i==j&&$scope.OppDDL.splice(i,1)})};$scope.save=function(){$http.post("/WorkNotification/SaveWNEquipmentOpportunity",JSON.stringify($scope.OppDDL)).then(function(response){response.data.isException?alertFactory.setMessage({type:response.data.type,msg:response.data.message}):(alertFactory.setMessage({type:"success",msg:"Data saved Successfully."}),setTimeout(function(){$uibModalInstance.close(!0)},1e3));$scope.isProcess=!1},function(response){$scope.isProcess=!1;alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})};$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});app.controller("skfAttachmentCtrl",function($scope,$uibModalInstance,params,$timeout,$http,alertFactory){$scope.iframe=!1;$scope.noAttachment=!1;$scope.previewImg=!0;$scope.uploadFile=!0;$scope.languageId=params.languageId;$scope.aid=params.aId;$scope.Type=params.Type;$scope.AssetName=params.AssetName;$scope.rowData=params.row;$scope.IsEditable=params.IsEditable;$scope.attach=function(){$scope.attachments=$scope.rowData.attachment};$scope.saveDoc=function(){$scope.uploadDocument()};$scope.getAttachment=function(){var _url="/WorkNotification/GetWNAttachmentByEquipment?eid="+$scope.eid+"&status=Y";$http.get(_url).then(function(response){$scope.attachment=response.data;angular.forEach($scope.attachment,function(val){val.attachId=val.WNId});$scope.attachment.length<=0&&($scope.noAttachment=!0);$scope.attImage="";$scope.previewImg=!0;$scope.FileName=""})};$scope.getAttachment();$scope.removeAttachment=function(AttachmentId,Type){var _url="/WorkNotification/DeleteAttachment?Type="+Type+"&aId="+AttachmentId;$http.post(_url).then(function(){$timeout(function(){$scope.getAttachment();$scope.attImage="";$scope.FileName="";$scope.previewImg=!0},50)})};$scope.readURL=function(input){var i,reader;for($scope.thumb=[],i=0;i<input.files.length;i++)input.files&&input.files[i]&&(reader=new FileReader,reader.onload=function(e){$scope.thumb.push(e.target.result)},reader.readAsDataURL(input.files[i]))};$scope.uploadDocument=function(){var fileUpload=$("#files").get(0),files=fileUpload.files,data=new FormData,i;if($scope.aid){for(i=0;i<files.length;i++)data.append(files[i].name,files[i]);$.ajax({type:"POST",url:"/WorkNotification/UploadFiles",contentType:!1,processData:!1,headers:{aId:$scope.aid,type:$scope.Type},data:data,success:function(){$timeout(function(){alertFactory.setMessage({msg:"Document uploaded successfully."});$scope.noAttachment=!1;$scope.getAttachment()},50);$("#files").val("");var _files=$.map($("#files").prop("files"),function(val){return val.name});$scope.fileLength=_files.length},error:function(){alertFactory.setMessage({type:"warning",msg:"Document uploaded successfully."})}})}};$scope.validFormat=!1;$scope.uploadImageStart=function(){$scope.validFormat=!1;var fileUpload=$("#files").get(0),files=fileUpload.files,_files=$.map($("#files").prop("files"),function(val){return val.name});angular.forEach(_files,function(filename){var filext=filename.substring(filename.lastIndexOf(".")+1);filext=filext.toLowerCase()});fileUpload?$timeout(function(){$scope.readURL(fileUpload);$scope.validFormat=!0},10):$timeout(function(){alertFactory.setMessage({type:"warning",msg:"Upload valid Image Format (png,jpg,jpeg and svg)"});$scope.validFormat=!1;$("#files").val("")},10)};$scope.showAttach=function(data){var _url="/WorkNotification/GetWNAttachmentByEquipment?eid="+$scope.eid+"&status=Y";$http.get(_url).then(function(response){$scope.attach=response.data;angular.forEach($scope.attach,function(val){data==val.WNAttachmentId&&($scope.FileName=val.FileName,$scope.attImage=val.PhysicalPath,$scope.previewImg=!1)})})};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});app.controller("skfAssetDatailPopupCtrl",function($scope,$uibModalInstance,params){$scope.AssetName=params.row.AssetName;$scope.ConditionCode=params.row.ConditionName;$scope.ConfidentFactor=params.row.ConfidentFactor;$scope.FailureProbFactor=params.row.FailureProbFactor;$scope.Recommendation=params.row.Recommendation;$scope.RepairCost=params.row.RepairCost;$scope.IndicatedFault=params.row.IndicatedFault;$scope.TotalOutageTime=params.row.TotalOutageTime;$scope.WNPriority=params.row.Priority;$scope.Comment=params.row.Comment;$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});app.controller("skfCancelCtrl",function($scope,$http,$uibModalInstance,params,uiGridConstants,alertFactory){var _params=params;$scope.formatters={};$scope.CancelRemarks="";$scope.save=function(){$scope.CancelRemarks.length>0?$uibModalInstance.close($scope.CancelRemarks):alertFactory.setMessage({type:"warning",msg:"Please fill the Comments to cancel the work notification"})};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});