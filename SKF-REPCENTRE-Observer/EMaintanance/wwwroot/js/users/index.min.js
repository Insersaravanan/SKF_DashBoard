app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.pinning","ui.grid.exporter","dndLists","ngSanitize","ui.select");app.controller("skfCtrl",function($scope,$filter,uiGridConstants,uiGridPinningConstants,$uibModal,$timeout,$http,languageFactory,alertFactory){function getCellClass(grid,row){return row.uid===highlightRow?"highlight":""}var _columns,highlightRow;$scope.startIndex=1;$scope.isEdit=!1;$scope.readOnlyPage=!1;$scope.isCreate=!1;$scope.isSearch=!0;$scope.formatters={};_columns=[{name:"sno",displayName:"#",width:"4%",minWidth:50,cellClass:getCellClass,enablePinning:!1,pinnedLeft:!0,aggregationHideLabel:!0,aggregationType:uiGridConstants.aggregationTypes.count,enableFiltering:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"UserName",displayName:"User Name",cellClass:getCellClass,enableColumnResizing:!0,width:"25%",minWidth:150,aggregationHideLabel:!1,aggregationType:uiGridConstants.aggregationTypes.count,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total Count: {{col.getAggregationValue() | number:0 }}<\/div>'},{name:"FirstName",displayName:"First Name",cellClass:getCellClass,enableColumnResizing:!0,width:"15%",minWidth:150},{name:"LastName",displayName:"Last Name",cellClass:getCellClass,enableColumnResizing:!0,width:"15%",minWidth:150},{name:"Mobile",displayName:"Mobile",cellClass:getCellClass,enableColumnResizing:!0,width:"10%",minWidth:100},{name:"EmailId",displayName:"Email",cellClass:getCellClass,enableColumnResizing:!0,width:"20%",minWidth:150},{name:"Action",enableFiltering:!1,enableSorting:!1,cellClass:getCellClass,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.editRow(row.entity) || grid.appScope.toggleCreate()" <i class="fa fa-pencil-square-o icon-space-before" tooltip-append-to-body="true" uib-tooltip="Edit User" tooltip-class="customClass"><\/i><\/a><a ng-click="grid.appScope.loadrelData(row.entity)" <i class="fa fa-link icon-space-before" tooltip-append-to-body="true" uib-tooltip="User RoleGroup Relation" tooltip-class="customClass"><\/i><\/a><a ng-click="grid.appScope.UserSiteAccess(row.entity)" <i class="fa fa-sitemap icon-space-before" tooltip-append-to-body="true" uib-tooltip="User Site Access" tooltip-class="customClass"><\/i><\/a><\/div>',width:"9%",minWidth:100}];$scope.editRow=function(row){$scope.isEdit=!0;$scope.isCreate=!1;$scope.isSearch=!1;$scope.clearModal();$scope.Users.UserTypeId=row.UserTypeId;$scope.Users.UserStatusId=row.UserStatusId;$scope.Users=row};$scope.clearOut=function(){$scope.isEdit=!1;$scope.clearModal()};$scope.searchToggle=function(){$scope.isCreate=!1;$scope.isEdit=!1;$scope.isSearch=!0};$scope.createToggle=function(){$scope.isCreate=!0;$scope.isSearch=!1;$scope.isEdit=!1;$scope.clearModal()};$scope.validateDomain=function(){if($scope.Users.UserName.length>0){var domain=$scope.Users.UserName.replace(/.*@/,"");domain.length>0&&(domain.toUpperCase()=="SKF.COM"?angular.forEach($scope.UserTypeDDL,function(val){val.LookupCode=="IUSR"&&($scope.Users.UserTypeId=val.LookupId)}):$scope.Users.UserTypeId=null)}};$scope.resetForm=function(){setTimeout(function(){for(var elements=document.getElementsByName("userForm")[0].querySelectorAll(".has-error"),i=0;i<elements.length;i++)elements[i].className=elements[i].className.replace(/\has-error\b/g,"")},500)};$scope.clearModal=function(){$scope.readOnlyPage=!1;$scope.isProcess=!1;$scope.Users={LookupId:0,UserId:0,LanguageId:$scope.language.LanguageId,UserName:null,FirstName:null,MiddleName:null,LastName:null,EmailId:null,UserTypeId:null,UserStatusId:null,Mobile:null,Phone:null,CreatedBy:0,Active:"Y"};$scope.resetForm()};$scope.clearValue=function(){$scope.S_Users={_UserStatusId:"",_UserTypeId:""}};$scope.clearValue();highlightRow=null;$scope.columns=angular.copy(_columns);$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)};gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus"&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_Users.xlsx",exporterExcelSheetName:"EMaintenance_Users",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.loadData=function(){$scope.S_Users.languageId=$scope.language.LanguageId;$scope.gridOpts.data=[];$scope.isPageLoad=!0;$scope.S_Users.UserTypeId=$scope.S_Users._UserTypeId?parseInt($scope.S_Users._UserTypeId):0;$scope.S_Users.UserStatusId=$scope.S_Users._UserStatusId?parseInt($scope.S_Users._UserStatusId):0;$http.post("/Users/Search",JSON.stringify($scope.S_Users)).then(function(response){response.data&&($scope.gridOpts.data=response.data,angular.forEach($scope.gridOpts.data,function(val,i){val.sno=i+1}))},function(response){alertFactory.setMessage({type:"warning",msg:String(response.data.message)})})};$scope.loadUserType=function(){var _url="/Lookup/GetLookupByName?lId="+$scope.language.LanguageId+"&lName=UserType";$http.get(_url).then(function(response){$scope.UserTypeDDL=response.data})};$scope.loadUserStatus=function(){var _url="/Lookup/GetLookupByName?lId="+$scope.language.LanguageId+"&lName=UserStatus";$http.get(_url).then(function(response){$scope.UserStatusDDL=response.data})};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!=oldValue&&newValue&&($scope.language=newValue,$scope.loadData(),$scope.loadUserStatus(),$scope.loadUserType())});$scope.save=function(){if($scope.userForm.$valid&&!$scope.isProcess&&!$scope.readOnlyPage){$scope.isProcess=!0;$http.post("/Users/Create",JSON.stringify($scope.Users)).then(function(response){response.data&&(alertFactory.setMessage({msg:"Data saved Successfully."}),$scope.createToggle(),$scope.clearValue(),$scope.loadData());$scope.isProcess=!1},function(response){$scope.isProcess=!1;alertFactory.setMessage({type:"warning",msg:String(response.data.message)})})}};$scope.update=function(){if($scope.userForm.$valid&&!$scope.isProcess&&!$scope.readOnlyPage){$scope.isProcess=!0;$http.post("/Users/Update/",JSON.stringify($scope.Users)).then(function(response){response.data&&(alertFactory.setMessage({msg:"Data updated Successfully."}),$scope.searchToggle(),$scope.loadData());$scope.isProcess=!1},function(response){$scope.isProcess=!1;alertFactory.setMessage({type:"warning",msg:String(response.data.message)})})}};$scope.roleGroupRelation=function(row,data){var modalInstance=$uibModal.open({templateUrl:"skfRoleGroupModal.html",controller:"skfRoleGroupModalCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row,data:data}}}});modalInstance.result.then(function(){$scope.loadData()},function(){$scope.loadData()})};$scope.loadrelData=function(row){$http.get("/UserRoleGroupRel/GetUserRoleGroupAccess?uId="+row.UserId+"&lId="+$scope.language.LanguageId).then(function(response){response.data&&$scope.roleGroupRelation(row,response.data)})};$scope.UserSiteAccess=function(row){var modalInstance=$uibModal.open({templateUrl:"skfUsersiteAccess.html",controller:"skfUsersiteAccessCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{row:row,languageId:$scope.language.LanguageId}}}});modalInstance.result.then(function(){},function(){})};$scope.import=function(){$scope.segment="User";var modalInstance=$uibModal.open({templateUrl:"skfImportModal.html",controller:"skfImportModalCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{language:$scope.language,templateName:$scope.segment}}}});modalInstance.result.then(function(){$scope.loadData()},function(){$scope.loadData()})}});app.controller("skfRoleGroupModalCtrl",function($scope,$http,$uibModalInstance,params,alertFactory){var _data=JSON.parse(params.data[0].RoleGroupRelation)[0];$scope.userName=params.row.UserName;$scope.models=[{listName:"Available",cssClass:"warning",items:_data.Available?_data.Available:[],dragging:!1},{listName:"Associated",cssClass:"success",items:_data.Associated?_data.Associated:[],dragging:!1}];$scope.getSelectedItemsIncluding=function(list,item){return item.selected=!0,list.items.filter(function(item){return item.selected})};$scope.btnright=!1;$scope.btnleft=!1;$scope.setSelected=function(list,item){item.selected=!item.selected;list.selectFlag=!(list.items.length==list.items.filter(function(item){return item.selected}).length);$scope.btnright=item.selected&&list.listName=="Available"?!0:!1;$scope.btnleft=item.selected&&list.listName=="Associated"?!0:!1};$scope.onDragstart=function(list,event){if(list.dragging=!0,event.dataTransfer.setDragImage){var img=new Image;img.src="images/ic_content_copy_black_24dp_2x.png";event.dataTransfer.setDragImage(img,0,0)}};$scope.onDrop=function(list,items,index){return angular.forEach(items,function(item){item.selected=!1}),list.selectFlag=!0,list.items=list.items.slice(0,index).concat(items).concat(list.items.slice(index)),$scope.btnright=!1,$scope.btnleft=!1,!0};$scope.onMoved=function(list){list.selectFlag=!0;list.items=list.items.filter(function(item){return!item.selected})};$scope.ShuttleRight=function(list){$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,angular.forEach($scope.models,function(data,_i){_i==1?data.items.push(item):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.ShuttleRightAll=function(list){angular.forEach(list.items,function(item){item.selected=!0});$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,angular.forEach($scope.models,function(data,_i){_i==1?data.items.push(item):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.ShuttleLeft=function(list){$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,angular.forEach($scope.models,function(data,_i){_i==0?data.items.push(item):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.ShuttleLeftAll=function(list){angular.forEach(list.items,function(item){item.selected=!0});$scope.ListItems=list;for(var i=$scope.ListItems.items.length-1;i>=0;i--)angular.forEach($scope.ListItems.items,function(item,i){item.selected==!0&&(item.selected=!1,angular.forEach($scope.models,function(data,_i){_i==0?data.items.push(item):(data.items.splice(i,1),$scope.btnright=!1,$scope.btnleft=!1)}))})};$scope.save=function(){var postData={},postUrl;postData.UserId=_data.Userid;postData.Relations=[];angular.forEach($scope.models,function(m){angular.forEach(m.items,function(item){item.Active=m.listName=="Associated"?"Y":"N";postData.Relations.push(item)})});$scope.isProcess||($scope.isProcess=!0,postUrl="/UserRoleGroupRel/Create",$http.post(postUrl,JSON.stringify(postData)).then(function(response){response.data&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):alertFactory.setMessage({msg:"Data updated Successfully."}));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})}))};$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});app.controller("skfUsersiteAccessCtrl",function($scope,$http,$uibModalInstance,params,alertFactory){$scope.userName=params.row.UserName;$scope.UserTypeCode=params.row.UserTypeCode;$scope.oneAtATime=!0;$scope.status={isFirstOpen:!0,isFirstDisabled:!1};$scope.intern={};$scope.intern.selectedCountries=[];$scope.intern.selectedClientSite=[];$scope.intern.selectedCostcentre=[];$scope.intern.selectedClient=[];$scope.UserClientRelation=function(){angular.forEach($scope.UserClientRel,function(val,a){a=="CountryRelations"&&($scope.countries=val,angular.forEach(val,function(_country){_country.Active=="Y"&&(_country.selected=!0,$scope.intern.selectedCountries.push(_country))}));a=="CostCentreRelations"&&($scope.CostcentreDDL=val,angular.forEach(val,function(_costcentre){_costcentre.Active=="Y"&&(_costcentre.selected=!0,$scope.intern.selectedCostcentre.push(_costcentre))}));a=="ClientRelations"&&($scope.clientDDL=val,angular.forEach(val,function(_client){_client.Active=="Y"&&(_client.selected=!0,$scope.intern.selectedClient.push(_client))}));a=="ClientSiteRelations"&&($scope.ClientSiteDDL=val,angular.forEach(val,function(_clientsite){_clientsite.Active=="Y"&&(_clientsite.selected=!0,$scope.intern.selectedClientSite.push(_clientsite))}))})};$scope.save=function(){$scope.countryList=[];$scope.costCentreList=[];$scope.clientSiteList=[];$scope.clientList=[];angular.forEach($scope.UserClientRel,function(val,a){a=="CountryRelations"&&angular.forEach(val,function(_country){$scope.intern.selectedCountries.length>0&&angular.forEach($scope.intern.selectedCountries,function(S_country){_country.CountryName==S_country.CountryName&&(S_country.Active=="N"?(_country.Active="Y",_country.isDirty=!0,$scope.countryList.push(_country)):_country.isDirty=!1)});_country.selected&&typeof _country.isDirty=="undefined"&&_country.Active=="Y"&&(_country.Active="N",_country.isDirty=!0,$scope.countryList.push(_country))});a=="CostCentreRelations"&&angular.forEach(val,function(_costcentre){$scope.intern.selectedCostcentre.length>0&&angular.forEach($scope.intern.selectedCostcentre,function(S_costcentre){_costcentre.CostCentreName==S_costcentre.CostCentreName&&(S_costcentre.Active=="N"?(_costcentre.Active="Y",_costcentre.isDirty=!0,$scope.costCentreList.push(_costcentre)):_costcentre.isDirty=!1)});_costcentre.selected&&typeof _costcentre.isDirty=="undefined"&&_costcentre.Active=="Y"&&(_costcentre.Active="N",_costcentre.isDirty=!0,$scope.costCentreList.push(_costcentre))});a=="ClientSiteRelations"&&angular.forEach(val,function(_ClientSite){$scope.intern.selectedClientSite.length>0&&angular.forEach($scope.intern.selectedClientSite,function(S_clientSite){_ClientSite.ClientSiteName==S_clientSite.ClientSiteName&&(S_clientSite.Active=="N"?(_ClientSite.Active="Y",_ClientSite.isDirty=!0,$scope.clientSiteList.push(_ClientSite)):_ClientSite.isDirty=!1)});_ClientSite.selected&&typeof _ClientSite.isDirty=="undefined"&&_ClientSite.Active=="Y"&&(_ClientSite.Active="N",_ClientSite.isDirty=!0,$scope.clientSiteList.push(_ClientSite))});a=="ClientRelations"&&angular.forEach(val,function(_client){$scope.intern.selectedClient&&angular.forEach($scope.intern.selectedClient,function(S_client){_client.ClientName==S_client.ClientName&&(S_client.Active=="N"?(_client.Active="Y",_client.isDirty=!0,$scope.clientList.push(_client)):_client.isDirty=!1)});_client.selected&&typeof _client.isDirty=="undefined"&&_client.Active=="Y"&&(_client.Active="N",_client.isDirty=!0,$scope.clientList.push(_client))})});$scope.isProcess=!0;var UserClientRel={CountryRelations:$scope.countryList,CostCentreRelations:$scope.costCentreList,ClientSiteRelations:$scope.clientSiteList,ClientRelations:$scope.clientList,LanguageId:params.languageId,Userid:params.row.UserId};$http.post("/UserClientSiteRel/Create",JSON.stringify(UserClientRel)).then(function(response){response.data&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):alertFactory.setMessage({msg:"Data saved Successfully."}));$scope.isProcess=!1},function(response){$scope.isProcess=!1;response.data.message&&alertFactory.setMessage({type:"warning",msg:String(response.data.message),exc:String(response.data.exception)})})};$scope.UserClientRelinfo=function(){var _url="/UserClientSiteRel/GetUserSiteAccess?lId="+params.languageId+"&uId="+params.row.UserId;$http.get(_url).then(function(response){$scope.UserClientRel=JSON.parse(response.data[0].UserAccess)[0];$scope.UserClientRelation()})}();$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});app.controller("skfImportModalCtrl",function($scope,alertFactory,$timeout,$http,$uibModalInstance,params){$scope.formatters={};$scope.alerts=[];$scope.closeAlert=function(index){try{$scope.alerts.splice(index,1)}catch(e){}};$scope.gridOptions={rowTemplate:"<div ng-class=\"{'invalid-input':row.entity.validationStatus == 'E','valid-input':row.entity.validationStatus == 'V'}\"><div ng-repeat=\"(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name\" class=\"ui-grid-cell\" ng-class=\"{ 'ui-grid-row-header-cell': col.isRowHeader }\" ui-grid-cell><\/div><\/div>",enableFiltering:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh()},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_Export_"+params.templateName+".xlsx",exporterExcelSheetName:params.templateName,exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.reset=function(){$scope.gridOptions.data=[];$scope.gridOptions.columnDefs=[];$scope.stacked=[]};$scope.template=params.templateName;$scope.loadColumns=function(){$scope.gridOptions.colTemp=[];$http.get("/Lookup/GetLookupByName?lId="+params.language.LanguageId+"&lName="+$scope.template+"_Template").then(function(response){response.data&&response.data.length>0&&($scope.gridOptions.colTemp=response.data.map(function(d){var obj={};return obj[d.LValue]="",obj}))})};$scope.loadColumns(params.templateName);$scope.downloadTemplate=function(){var ws=XLSX.utils.json_to_sheet($scope.gridOptions.colTemp),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,$scope.template+"_Template");XLSX.writeFile(wb,$scope.template+"_Template.xlsx")};$scope.ok=function(){$uibModalInstance.close($scope.rowData)};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")};$scope.cancelProgress=function(){$scope.progressCall(!1)};$scope.saveData=function(){$scope.SaveDataQueue=angular.copy($scope.gridOptions.data);$scope.progressCall(!0)};$scope.progressCall=function(flag){$scope.isProgress=flag;$timeout(function(){var _total=$scope.gridOptions.data.length,_progressed=_total-$scope.SaveDataQueue.length,_errorCount=$scope.gridOptions.data.filter(data=>data.validationStatus&&data.validationStatus==="E").length;flag?$scope.sendDataToImport(5):$scope.SaveDataQueue=[];$scope.stacked=[];$scope.stacked.push({value:Math.round((_progressed-_errorCount)/_total*100),type:"success",title:_progressed-_errorCount+" items Successfully updated"});$scope.stacked.push({value:Math.round(_errorCount/_total*100),type:"warning",title:_errorCount+" items having issue to upload."})},1)};$scope.updateGridData=function(col,flag){var _grid=$scope.gridOptions.data,_flag;angular.forEach(col,function(val,i){for(var i=0,len=_grid.length;i<len;i++)if(_grid[i].ReferenceNo==val.ReferenceNo){_grid[i].validationStatus=val.validationStatus;_grid[i].ValidationResult=val.ValidationResult;break}});_flag=$scope.SaveDataQueue.length>0&&flag?!0:!1;$scope.progressCall(_flag)};$scope.sendDataToImport=function(chunk){var postData={},postUrl;postData=$scope.SaveDataQueue.splice(0,chunk);postUrl="/Users/Import";$http.post(postUrl,JSON.stringify(postData)).then(function(response){response.data?alertFactory.setMessage({msg:"Data saved Successfully."}):response.data.isException&&$scope.alerts.push({type:"warning",msg:String(response.data.message)})},function(response){$scope.alerts.push({type:"warning",msg:String(response.data.message)})})}});app.directive("fileread",[function(){return{scope:{opts:"="},link:function($scope,$elm){$elm.on("change",function(changeEvent){var reader=new FileReader;$scope.opts.invalidUpload=!1;reader.onload=function(evt){$scope.$apply(function(){var _data=evt.target.result,workbook=XLSX.read(_data,{type:"binary"}),headerNames=XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]],{header:1})[0],data=XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]),validateFile;$scope.opts.columnDefs=[];$scope.opts.columnDefs.push({field:"Sno",width:55,enableFiltering:!1,cellTemplate:'<div class="ui-grid-cell-contents"><p>{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/p><\/div>'});validateFile=!0;headerNames.forEach(function(h){validateFile&&($scope.opts.columnDefs.push({field:h,minWidth:150}),validateFile=$scope.opts.colTemp.some(function(val){return val[h]!==undefined}))});$scope.opts.columnDefs.push({field:"ValidationResult",minWidth:150,cellTemplate:'<div class="ui-grid-cell-contents"><p tooltip-append-to-body="true" uib-tooltip="{{row.entity.ValidationResult}}" tooltip-class="customClass import-tooltip">{{row.entity.ValidationResult}}<\/p><\/div>'});validateFile&&$scope.opts.colTemp.length===$scope.opts.columnDefs.length-2?$scope.opts.data=data.map(function(item,i){return item.ReferenceNo=i+1,item}):($scope.opts.columnDefs=[],$scope.opts.invalidUpload=!0);$elm.val(null)})};reader.readAsBinaryString(changeEvent.target.files[0])})}}}]);