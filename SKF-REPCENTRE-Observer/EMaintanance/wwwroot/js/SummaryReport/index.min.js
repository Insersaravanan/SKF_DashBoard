app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.pinning");app.controller("skfCtrl",function($scope,$filter,$window,$timeout,$http,alertFactory,$uibModal,uiGridConstants,utility,clientFactory,languageFactory){function getCellClass(grid,row){return row.uid===highlightRow?"highlight":""}var highlightRow,date,d;$scope.columns=[{name:"sno",displayName:"#",width:"50",enablePinning:!1,enableCellEdit:!1,enableFiltering:!1},{name:"JobNumber",displayName:"Job No",enableColumnResizing:!0,width:"20%",enableCellEdit:!1},{name:"JobName",displayName:"Job Name",enableColumnResizing:!0,width:"30%",enableCellEdit:!1},{name:"EstStartDate",displayName:"Est. Start Date",enableColumnResizing:!0,width:"30%",enableCellEdit:!1},{name:"Action",enableFiltering:!1,enableSorting:!1,cellClass:getCellClass,enableCellEdit:!1,width:"15%",minWidth:100,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.Report(row)" <i class="fa fa-print icon-space-before" tooltip-append-to-body="true" uib-tooltip="Summary Report" tooltip-class="customClass"><\/i><\/a><a ng-click="grid.appScope.downloadExcel(row.entity)"}> <i class="fa fa-file-excel-o icon-space-before" tooltip-append-to-body="true" uib-tooltip="Download" tooltip-class="customClass"><\/i><\/a><\/div>'}];$scope.DownloadSummaryReportExcelByDateRange=function(){if($scope.smReport={ClientSiteId:$scope.ClientSiteId,ReportFromDate:$filter("date")($scope.FromDate,"yyyy-MM-dd"),ReportToDate:$filter("date")($scope.ToDate,"yyyy-MM-dd"),LanguageId:$scope.language.LanguageId},typeof $scope.smReport.ReportFromDate!="undefined"&&typeof $scope.smReport.ReportToDate!="undefined")$http.post("/SummaryReport/GetSummaryReportDateRangeToDownload",JSON.stringify($scope.smReport)).then(function(response){$scope.template=$filter("date")($scope.FromDate,"yyyy-MM-dd")+"-"+$filter("date")($scope.ToDate,"yyyy-MM-dd");$scope.download=response.data;var ws=XLSX.utils.json_to_sheet($scope.download),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,$scope.template+"");XLSX.writeFile(wb,"SummaryReport-"+$scope.template+".xlsx")});else alertFactory.setMessage({type:"warning",msg:"Please fill the Start and End date"})};$scope.downloadExcel=function(row){var postUrl="SummaryReport/GetSummaryReportToDownload?jId="+row.JobId+"&lId="+$scope.language.LanguageId;$http.get(postUrl).then(function(response){$scope.template=row.JobNumber;$scope.download=response.data;var ws=XLSX.utils.json_to_sheet($scope.download),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,$scope.template+"");XLSX.writeFile(wb,"SummaryReport_"+$scope.template+".xlsx")})};highlightRow=null;$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableCellEdit:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;gridApi.core.on.renderingComplete($scope,function(){console.log(gridApi.grid)});$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)};gridApi.cellNav.on.navigate($scope,function(selected){".ui-grid-cell-focus"&&(highlightRow=selected.row.uid,gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN))})},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_JobList.xlsx",exporterExcelSheetName:"EMaintenance_JobList",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.open=function(){var modalInstance=$uibModal.open({templateUrl:"skfPopupModal.html",controller:"skfPopupModalCtrl",size:"lg",backdrop:"static",keyboard:!1,resolve:{params:function(){return{}}}});modalInstance.result.then(function(){},function(){})};$scope.clearValue=function(){$scope.FromDate=null;$scope.ToDate=null;$scope.ConditionCodeId=null};date=new Date;d=date.getDate()-90;y=date.getFullYear();m=date.getMonth();$scope.FromDate=new Date(y,m,d);$scope.loadData=function(){$scope.gridOpts.data=[];$scope.isPageLoad=!0;$scope.smReport={ClientSiteId:$scope.ClientSiteId,ReportFromDate:$filter("date")($scope.FromDate,"yyyy-MM-dd"),ReportToDate:$filter("date")($scope.ToDate,"yyyy-MM-dd"),LanguageId:$scope.language.LanguageId};$http.post("/SummaryReport/GetSummaryReportList/",JSON.stringify($scope.smReport)).then(function(response){$scope.gridOpts.data=response.data;angular.forEach($scope.gridOpts.data,function(val,i){val.sno=i+1})})};$scope.selectClient=function(){var clientInfo=sessionStorage.getItem("clientInfo"),_client;clientFactory.setClient(clientInfo);clientInfo==null?sessionStorage.setItem("isClientSite","yes"):clientInfo&&clientInfo!="undefined"&&(_client=JSON.parse(clientInfo),$scope.ClientSiteId=_client.ClientSiteId)};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!=oldValue&&newValue&&($scope.language=newValue,$scope.selectClient(),$scope.loadData())});$scope.Report=function(row){var mapForm=document.createElement("form"),Language,Job,Client,Type;mapForm.target="Map";mapForm.method="POST";mapForm.action="/report";mapForm.setAttribute("class","report-append-view");Language=document.createElement("input");Language.type="text";Language.name="LanguageId";Language.value=$scope.language.LanguageId;mapForm.appendChild(Language);Job=document.createElement("input");Job.type="text";Job.name="JobId";Job.value=row.entity.JobId;mapForm.appendChild(Job);Client=document.createElement("input");Client.type="text";Client.name="ClientSiteId";Client.value=$scope.ClientSiteId;mapForm.appendChild(Client);Type=document.createElement("input");Type.type="text";Type.name="Type";Type.value="SR";mapForm.appendChild(Type);document.body.appendChild(mapForm);map=window.open("","Map","status=0,title=0,height=600,width=800,scrollbars=1");map?mapForm.submit():alert("You must allow popups for this map to work.")}});