app.requires.push("commonMethods","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.edit","ui.grid.cellNav","ui.grid.pinning","ui.grid.exporter");app.controller("skfCtrl",function($scope,$filter,uiGridConstants,$http,$uibModal,languageFactory,alertFactory,clientFactory,$timeout){var _columns,_columns1;$scope.startIndex=1;$scope.isEdit=!1;$scope.isCreate=!1;$scope.isSearch=!0;$scope.readOnlyPage=!1;$scope.formatters={};$scope.language=null;$scope.exportLeverageActive=!0;$scope.next=function(stage){$scope.exportListActive=!1;$scope.exportLeverageActive=!1;(stage=="stage1"||stage=="stage0")&&(stage=="stage1"?($scope.exportListActive=!0,$scope.loadExport()):$scope.exportLeverageActive=!0,$scope.stage=stage,$scope.moreFields=!1)};_columns=[{name:"sno",displayName:"#",width:"50",cellClass:"lock-pinned",enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"ClientName",displayName:"Client Name",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"10%",minWidth:100},{name:"PlantArea",displayName:"Plant",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"12%",minWidth:100},{name:"EquipmentName",displayName:"Equipment Name",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"12%",minWidth:100},{name:"JobNumber",displayName:"Job Number",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"5%",minWidth:100},{name:"OpportunityType",displayName:"Opportunities",enableCellEdit:!1,enableFiltering:!0,width:"20%",minWidth:100},{name:"Descriptions",displayName:"Descriptions",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"24%",minWidth:100},{name:"Status",displayName:"Action",enableFiltering:!1,enableCellEdit:!1,headerCellTemplate:'<label class="ui-grid-cell-contents"><span>Select All &nbsp;&nbsp<\/span><input type="checkbox" class="header-checkbox" ng-click="grid.appScope.SelectAll()" ng-true-value="\'Y\'" ng-false-value="\'N\'"><\/label>',type:"boolean",cellTemplate:'<label class="ui-grid-cell-contents grid-checkbox"><input type="checkbox" ng-model="row.entity.Status" ng-click="grid.appScope.SelectedRow(row.entity)" ng-true-value="\'Y\'" ng-false-value="\'N\'"><\/label>',width:"10%",minWidth:50}];$scope.SelectedRow=function(row){row.isDirty=!0};$scope.loadCountry=function(){$scope.CountryDDL=[];$scope.defaultCountry={CountryId:0,CountryName:"--Select--"};var _url="/taxonomy/GetLoadListItem?Type=UserCountryAccess&lId="+$scope.language.LanguageId+"&sId=0&sId1=0";$http.get(_url).then(function(response){$scope.CountryDDL=response.data;$scope.CountryDDL.splice(0,0,$scope.defaultCountry)})};$scope.SelectAll=function(){$scope.filteredRows=$scope.gridApi.core.getVisibleRows($scope.gridApi.grid);$scope.selectAll?$scope.selectAll&&angular.forEach($scope.filteredRows,function(val){val.entity.isDirty=!0;val.entity.Status="N";$scope.selectAll=!1}):angular.forEach($scope.filteredRows,function(val){val.entity.Status="Y";val.entity.isDirty=!0;$scope.selectAll=!0})};$scope.columns=angular.copy(_columns);$scope.gridOpts={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)}},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_Leverage.xlsx",exporterExcelSheetName:"EMaintenance_Leverage",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.loadData=function(){$scope.L_Leverage.languageId=$scope.language.LanguageId;$scope.gridOpts.data=[];$scope.isPageLoad=!0;$scope.L_Leverage={LeverageFromDate:$filter("date")($scope.L_Leverage.LeverageFromDate,"yyyy-MM-dd 00:00:00"),LeverageToDate:$filter("date")($scope.L_Leverage.LeverageToDate,"yyyy-MM-dd 00:00:00"),CountryId:$scope.L_Leverage.CountryId};$http.post("/LeverageExport/GetLeveragesByParams",JSON.stringify($scope.L_Leverage)).then(function(response){response.data&&($scope.gridOpts.data=response.data,$scope.L_Leverage.LeverageFromDate=new Date($scope.L_Leverage.LeverageFromDate),$scope.L_Leverage.LeverageToDate=new Date($scope.L_Leverage.LeverageToDate),angular.forEach($scope.gridOpts.data,function(val,i){val.sno=i+1}))},function(response){$scope.alerts.push({type:"warning",msg:String(response.data.message)})})};$scope.loadJobStatus=function(){var _url="/Lookup/GetLookupByName?lId="+$scope.language.LanguageId+"&lName=JobProcessStatus";$http.get(_url).then(function(response){$scope.LeverageDDL=response.data})};$scope.selectClient=function(){var clientInfo=sessionStorage.getItem("clientInfo"),_client;clientFactory.setClient(clientInfo);clientInfo==null?sessionStorage.setItem("isClientSite","yes"):clientInfo&&clientInfo!="undefined"&&(_client=JSON.parse(clientInfo),$scope.ClientSiteId=_client.ClientSiteId)};$scope.$watch(function(){return languageFactory.getLanguage()},function(newValue,oldValue){newValue!=oldValue&&newValue&&($scope.language=newValue,$scope.selectClient(),$scope.loadJobStatus(),$scope.loadCountry(),$scope.loadData())});$scope.clearOut=function(){$scope.clearValue()};var date=new Date,y=date.getFullYear(),m=date.getMonth();$scope.clearValue=function(){$scope.L_Leverage={LeverageFromDate:new Date(y,m-1,1),LeverageToDate:new Date}};$scope.clearValue();$scope.save=function(){var LeverageServices=[],postData,postUrl;$scope.LeverageServices=$scope.SelectedRow;angular.forEach($scope.gridOpts.data,function(val){val.isDirty===!0&&val.Status==="Y"&&LeverageServices.push({LeverageServiceId:val.LeverageServiceId})});!$scope.isProcess&&LeverageServices.length>0?(postData={LeverageServices:LeverageServices},$scope.isProcess=!0,postUrl="/LeverageExport/ExportLeverage",$http.post(postUrl,JSON.stringify(postData)).then(function(response){response.status&&(response.data.toString().indexOf("<!DOCTYPE html>")>=0?alertFactory.setMessage({type:"warning",msg:"User not a privileged to perform this Action. Please Contact your Admin.."}):alertFactory.setMessage({msg:"Data Generated Successfully."}),$scope.loadData());$scope.isProcess=!1},function(response){$scope.isProcess=!1;alertFactory.setMessage({type:"warning",msg:String(response.data.message)})})):alertFactory.setMessage({type:"warning",msg:"Please select atleast one record"})};_columns1=[{name:"sno",displayName:"#",width:"50",cellClass:"lock-pinned",enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{grid.renderContainers.body.visibleRowCache.indexOf(row) + 1}}<\/div>'},{name:"FileDate",displayName:"File Date",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"20%",minWidth:50,cellFilter:"date:'dd/MM/yyyy'"},{name:"FileName",displayName:"File Name",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"30%",minWidth:50},{name:"FilePath",displayName:"File Path",enableColumnResizing:!0,enableCellEdit:!1,enableFiltering:!0,width:"28%",minWidth:50},{name:"Action",enableFiltering:!1,enableSorting:!1,enableCellEdit:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a ng-click="grid.appScope.downloadExcel(row.entity)" <i class="fa fa-download icon-space-before" tooltip-append-to-body="true" uib-tooltip="Download" tooltip-class="customClass"><\/i><\/a><\/div>',width:"18%",minWidth:100}];$scope.columns=angular.copy(_columns1);$scope.gridOpts1={columnDefs:$scope.columns,enableFiltering:!0,enablePinning:!0,enableCellEdit:!1,enableColumnResizing:!0,showColumnFooter:!0,enableRowSelection:!0,enableSorting:!0,onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.core.refresh();var col=$scope.columns;$scope.gridApi.grid.clearAllFilters=function(){$scope.gridOpts.columnDefs=[];$timeout(function(){$scope.gridOpts.columnDefs=angular.copy(_columns)},2)}},enableGridMenu:!0,enableSelectAll:!1,exporterMenuPdf:!1,exporterMenuCsv:!1,exporterExcelFilename:"EMaintenance_ExportList.xlsx",exporterExcelSheetName:"EMaintenance_ExportList",exporterExcelCustomFormatters:function(grid,workbook,docDefinition){var stylesheet=workbook.getStyleSheet(),stdStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri"}),boldStyle=stylesheet.createFontStyle({size:9,fontName:"Calibri",bold:!0}),aFormatDefn={font:boldStyle.id,alignment:{wrapText:!0}},formatter=stylesheet.createFormat(aFormatDefn),dateFormatter,singleDefn;return $scope.formatters.bold=formatter,dateFormatter=stylesheet.createSimpleFormatter("date"),$scope.formatters.date=dateFormatter,aFormatDefn={font:stdStyle.id,fill:{type:"pattern",patternType:"solid",fgColor:"FFFFC7CE"},alignment:{wrapText:!0}},singleDefn={font:stdStyle.id,format:"#,##0.0"},formatter=stylesheet.createFormat(aFormatDefn),$scope.formatters.red=formatter,Object.assign(docDefinition.styles,$scope.formatters),docDefinition},exporterExcelHeader:function(grid,workbook,sheet){var stylesheet=workbook.getStyleSheet(),formatterId=stylesheet.createFormat({font:{size:11,fontName:"Calibri",bold:!0},alignment:{wrapText:!0}}),cols;sheet.mergeCells("B1","C1");cols=[];cols.push({value:""});cols.push({value:"SKF",metadata:{style:formatterId.id}});sheet.data.push(cols)},exporterFieldFormatCallback:function(grid,row,gridCol,cellValue){var formatterId=null;return gridCol.field==="name"&&cellValue&&cellValue.startsWith("W")&&(formatterId=$scope.formatters.red.id),gridCol.field==="updatedDate"&&(formatterId=$scope.formatters.date.id),formatterId?{metadata:{style:formatterId}}:null},exporterColumnScaleFactor:4.5,exporterFieldApplyFilters:!0};$scope.clearExportValue=function(){$scope.L_ExportLeverage={FileFromDate:new Date(y,m-1,1),FileToDate:new Date}};$scope.clearExportValue();$scope.loadExport=function(){$scope.L_ExportLeverage.languageId=$scope.language.LanguageId;$scope.gridOpts1.data=[];$scope.isPageLoad=!0;$scope.L_ExportLeverage={FileFromDate:$filter("date")($scope.L_ExportLeverage.FileFromDate,"yyyy-MM-dd 00:00:00"),FileToDate:$filter("date")($scope.L_ExportLeverage.FileToDate,"yyyy-MM-dd 00:00:00")};$http.post("/LeverageExport/GetExportLeverageFiles",JSON.stringify($scope.L_ExportLeverage)).then(function(response){response.data&&($scope.gridOpts1.data=response.data,angular.forEach($scope.gridOpts1.data,function(val,i){val.sno=i+1}))},function(response){$scope.alerts.push({type:"warning",msg:String(response.data.message)})})};$scope.downloadExcel=function(row){var postUrl="LeverageExport/GetLeveragesToDownload?leId="+row.LeverageExportId+"&lId="+$scope.language.LanguageId;$http.get(postUrl).then(function(response){$scope.template=row.FileName;$scope.download=response.data;var ws=XLSX.utils.json_to_sheet($scope.download),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,$scope.template+"");XLSX.writeFile(wb,$scope.template+".xlsx")})}});